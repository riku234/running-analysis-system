import os
import json
import time
import asyncio
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import uvicorn
from typing import List, Dict, Any
import google.generativeai as genai
from dotenv import load_dotenv

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()

# Gemini APIã‚­ãƒ¼ã®å–å¾—ã¨æ¤œè¨¼
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
USE_GEMINI_API = bool(GEMINI_API_KEY)

if USE_GEMINI_API:
    # Gemini APIã®åˆæœŸåŒ–
    genai.configure(api_key=GEMINI_API_KEY)
    model = genai.GenerativeModel(
        'gemini-flash-latest',
        generation_config=genai.types.GenerationConfig(
            temperature=0.7,  # ã‚ˆã‚Šå‰µé€ çš„ã§è‡ªç„¶ãªå›ç­”
            top_p=0.8,       # å¤šæ§˜æ€§ã®ãƒãƒ©ãƒ³ã‚¹
            max_output_tokens=1000,  # ã‚ˆã‚Šè©³ç´°ãªå›ç­”ã‚’å¯èƒ½ã«
        ),
        safety_settings=[
            {'category': 'HARM_CATEGORY_HARASSMENT', 'threshold': 'BLOCK_NONE'},
            {'category': 'HARM_CATEGORY_HATE_SPEECH', 'threshold': 'BLOCK_NONE'},
            {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'threshold': 'BLOCK_NONE'},
            {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'threshold': 'BLOCK_NONE'},
        ]
    )
    print("âœ… Gemini APIæœ‰åŠ¹åŒ–")
else:
    model = None
    print("âš ï¸  Gemini APIã‚­ãƒ¼æœªè¨­å®š - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™")

app = FastAPI(
    title="Advice Generation Service (Gemini-Powered)",
    description="Gemini APIã‚’ä½¿ç”¨ã—ã¦ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã®æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹",
    version="2.0.0"
)

# CORSè¨­å®š
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class AdviceRequest(BaseModel):
    video_id: str
    issues: List[str]  # èª²é¡Œãƒªã‚¹ãƒˆï¼ˆissue_analysisã‹ã‚‰å—ã‘å–ã‚‹ï¼‰
    prompt_settings: Dict[str, Any] = None  # ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šï¼ˆä»»æ„ï¼‰

class AdviceResponse(BaseModel):
    status: str
    message: str
    advice_list: List[Dict[str, Any]]

class AdvancedAdviceRequest(BaseModel):
    video_id: str
    issues_list: List[str]  # Zå€¤åˆ¤å®šãªã©ã«ã‚ˆã£ã¦ç‰¹å®šã•ã‚ŒãŸèª²é¡Œã®ãƒªã‚¹ãƒˆ

class AdvancedAdviceResponse(BaseModel):
    status: str
    message: str
    video_id: str
    advice: str  # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæœ€çµ‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ–‡å­—åˆ—

class IntegratedAdviceRequest(BaseModel):
    video_id: str
    issues_list: List[str]  # Zå€¤åˆ¤å®šãªã©ã«ã‚ˆã£ã¦ç‰¹å®šã•ã‚ŒãŸèª²é¡Œã®ãƒªã‚¹ãƒˆ
    prompt_settings: Dict[str, Any] = None  # ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šï¼ˆä»»æ„ï¼‰

class IntegratedAdviceResponse(BaseModel):
    status: str
    message: str
    video_id: str
    integrated_advice: str  # ãƒ—ãƒ­ã‚³ãƒ¼ãƒï¼‹AIçµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹æ–‡å­—åˆ—

def get_advice_database():
    """èª²é¡Œã®çµ„ã¿åˆã‚ã›ã¨æ§‹é€ åŒ–ã•ã‚ŒãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹"""
    advice_db = {
        # å˜ä¸€ã®èª²é¡Œã«å¯¾ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹
        "ä½“å¹¹å¾Œå‚¾": {
            "description": "èµ°è¡Œä¸­ã«ä½“ãŒå¾Œã‚ã«å‚¾ã„ã¦ã„ã‚‹ï¼ˆå¾Œå‚¾ã—ã¦ã„ã‚‹ï¼‰å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "action": "ãŠã¸ãã‹ã‚‰å‰ã«å¼•ã£å¼µã‚‰ã‚Œã‚‹ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã€è‡ªç„¶ãªå‰å‚¾å§¿å‹¢ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚",
            "drill": "è£œå¼·ãƒ‰ãƒªãƒ«ã¨ã—ã¦ã€å£ã‚’ä½¿ã£ãŸå‰å‚¾å§¿å‹¢ã®ç·´ç¿’ï¼ˆã‚¦ã‚©ãƒ¼ãƒ«ãƒ‰ãƒªãƒ«ï¼‰ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        "ä½“å¹¹å‰å‚¾": {
            "description": "èµ°è¡Œä¸­ã«ä½“ãŒå‰ã«å€’ã‚Œã™ãã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "action": "èƒ¸ã‚’å¼µã‚Šã€é ­ã‚’ä¸Šã’ã¦ã€è‡ªç„¶ãªå§¿å‹¢ã§èµ°ã‚‹ã“ã¨ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚",
            "drill": "èƒŒç­‹ã‚’é›ãˆã‚‹ä½“å¹¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚„ãƒ—ãƒ©ãƒ³ã‚¯ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        "ä¸Šä¸‹å‹•å¤§": {
            "description": "ä¸Šä¸‹ã®å‹•ããŒå¤§ããã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ç„¡é§„ã«ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "action": "é ­ã®ä½ç½®ã‚’ãªã‚‹ã¹ãå¤‰ãˆãšã«ã€å‰ã«é€²ã‚€ã“ã¨ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚ãƒ”ãƒƒãƒã‚’å°‘ã—é€Ÿã‚ã‚‹ã¨æ”¹å–„ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚",
            "drill": "ç¸„è·³ã³ã¯ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦åœ°é¢ã‹ã‚‰ã®åç™ºã‚’ã‚‚ã‚‰ã†æ„Ÿè¦šã‚’é¤Šã†ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚"
        },
        "ãƒ”ãƒƒãƒä½": {
            "description": "æ­©æ•°ï¼ˆãƒ”ãƒƒãƒï¼‰ãŒé…ãã€åŠ¹ç‡çš„ã§ãªã„èµ°ã‚Šæ–¹ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "action": "1åˆ†é–“ã«180æ­©ç¨‹åº¦ã‚’ç›®æ¨™ã«ã€è»½ã‚„ã‹ã§ç´ æ—©ã„è¶³ã®å›è»¢ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚",
            "drill": "ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ã‚„ã‚¢ãƒ—ãƒªã‚’ä½¿ã£ã¦ã€ä¸€å®šã®ãƒªã‚ºãƒ ã§èµ°ã‚‹ç·´ç¿’ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        "ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰é•·": {
            "description": "æ­©å¹…ãŒé©åˆ‡ã§ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆé•·ã™ãã‚‹ã‹çŸ­ã™ãã‚‹ï¼‰ã€‚",
            "action": "ç„¡ç†ã«æ­©å¹…ã‚’åºƒã’ã‚‹ã®ã§ã¯ãªãã€è‡ªç„¶ãªæ­©å¹…ã§åŠ¹ç‡ã‚ˆãèµ°ã‚‹ã“ã¨ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚",
            "drill": "çŸ­ã„è·é›¢ã§ã®ã‚¹ãƒ—ãƒªãƒ³ãƒˆç·´ç¿’ã‚„ã€ãƒ©ãƒ€ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        "å³å¤§è…¿è§’åº¦å¤§": {
            "description": "å³è¶³ã®å¤§è…¿éƒ¨ã®è§’åº¦ãŒå¤§ããã€ã‚ªãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "action": "å³è¶³ã®ç€åœ°ä½ç½®ã‚’ä½“ã®é‡å¿ƒã«ã‚ˆã‚Šè¿‘ã¥ã‘ã‚‹ã“ã¨ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚",
            "drill": "å³è¶³ã‚’ä¸­å¿ƒã¨ã—ãŸç‰‡è¶³ç«‹ã¡ãƒãƒ©ãƒ³ã‚¹ç·´ç¿’ã‚„ã€å³è„šã®ã‚‚ã‚‚ä¸Šã’é‹å‹•ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        "å·¦å¤§è…¿è§’åº¦å¤§": {
            "description": "å·¦è¶³ã®å¤§è…¿éƒ¨ã®è§’åº¦ãŒå¤§ããã€ã‚ªãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "action": "å·¦è¶³ã®ç€åœ°ä½ç½®ã‚’ä½“ã®é‡å¿ƒã«ã‚ˆã‚Šè¿‘ã¥ã‘ã‚‹ã“ã¨ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚",
            "drill": "å·¦è¶³ã‚’ä¸­å¿ƒã¨ã—ãŸç‰‡è¶³ç«‹ã¡ãƒãƒ©ãƒ³ã‚¹ç·´ç¿’ã‚„ã€å·¦è„šã®ã‚‚ã‚‚ä¸Šã’é‹å‹•ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        "å³ä¸‹è…¿è§’åº¦å¤§": {
            "description": "å³è¶³ã®ä¸‹è…¿éƒ¨ã®è§’åº¦ãŒå¤§ããã€è¶³å…ˆç€åœ°ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "action": "å³è¶³å…¨ä½“ã§ç€åœ°ã—ã€ãƒŸãƒƒãƒ‰ãƒ•ãƒƒãƒˆç€åœ°ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚",
            "drill": "å³è¶³ã§ã®ã‹ã‹ã¨æ­©ãã‚„ã€ç‰‡è¶³ã§ã®ç€åœ°ç·´ç¿’ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        "å·¦ä¸‹è…¿è§’åº¦å¤§": {
            "description": "å·¦è¶³ã®ä¸‹è…¿éƒ¨ã®è§’åº¦ãŒå¤§ããã€è¶³å…ˆç€åœ°ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "action": "å·¦è¶³å…¨ä½“ã§ç€åœ°ã—ã€ãƒŸãƒƒãƒ‰ãƒ•ãƒƒãƒˆç€åœ°ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚",
            "drill": "å·¦è¶³ã§ã®ã‹ã‹ã¨æ­©ãã‚„ã€ç‰‡è¶³ã§ã®ç€åœ°ç·´ç¿’ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        
        # è¤‡æ•°ã®èª²é¡Œã‚’çµ„ã¿åˆã‚ã›ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹
        "å¤§è…¿è§’åº¦å¤§_ä¸‹è…¿è§’åº¦å¤§": {
            "description": "è¶³ãŒä½“ã®é‡å¿ƒã‚ˆã‚Šã‹ãªã‚Šå‰ã§ç€åœ°ã—ã¦ãŠã‚Šã€ãƒ–ãƒ¬ãƒ¼ã‚­ãŒã‹ã‹ã‚Šã‚„ã™ã„èµ°ã‚Šæ–¹ã«ãªã£ã¦ã„ã¾ã™ã€‚",
            "action": "ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚’ç„¡ç†ã«åºƒã’ã‚‹ã®ã§ã¯ãªãã€ä»Šã‚ˆã‚Šã‚‚ã€çœŸä¸‹ã€ã«ç€åœ°ã™ã‚‹æ„è­˜ã‚’æŒã¡ã¾ã—ã‚‡ã†ã€‚",
            "drill": "ãã®å ´ã§ã®ã‚‚ã‚‚ä¸Šã’ã‚„ã€ãƒŸãƒ‹ãƒãƒ¼ãƒ‰ãƒ«ã‚’ä½¿ã£ãŸãƒ‰ãƒªãƒ«ã§ã€è¶³ã‚’ç´ æ—©ãå¼•ãä¸Šã’ã‚‹å‹•ãã‚’ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚"
        },
        "ä½“å¹¹å‰å‚¾_ä¸Šä¸‹å‹•å¤§": {
            "description": "ä½“ãŒå‰ã«å€’ã‚Œã™ãã¦ã€åŒæ™‚ã«ä¸Šä¸‹å‹•ã‚‚å¤§ãããªã‚Šã€ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹ç‡ãŒæ‚ªåŒ–ã—ã¦ã„ã¾ã™ã€‚",
            "action": "ã¾ãšä¸Šä½“ã‚’èµ·ã“ã—ã¦å®‰å®šã—ãŸå§¿å‹¢ã‚’ä½œã‚Šã€ãã®å¾Œã«ä¸Šä¸‹å‹•ã‚’æŠ‘ãˆã‚‹æ„è­˜ã‚’æŒã¡ã¾ã—ã‚‡ã†ã€‚",
            "drill": "ä½“å¹¹ã‚’é›ãˆã‚‹åŸºæœ¬å§¿å‹¢ç·´ç¿’ã¨ã€å¹³åœ°ã§ã®ã‚†ã£ãã‚Šã‚¸ãƒ§ã‚®ãƒ³ã‚°ã§æ„Ÿè¦šã‚’æ´ã¿ã¾ã—ã‚‡ã†ã€‚"
        },
        "ä½“å¹¹å¾Œå‚¾_ãƒ”ãƒƒãƒä½": {
            "description": "ä½“ãŒå¾Œå‚¾ã—ã€åŒæ™‚ã«ãƒ”ãƒƒãƒã‚‚é…ã„ãŸã‚ã€æ¨é€²åŠ›ãŒååˆ†ã«å¾—ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
            "action": "ã¾ãšå‰å‚¾å§¿å‹¢ã‚’æ„è­˜ã—ã€ãã®å§¿å‹¢ã®ã¾ã¾ãƒ”ãƒƒãƒã‚’ä¸Šã’ã‚‹ç·´ç¿’ã‚’ã—ã¾ã—ã‚‡ã†ã€‚",
            "drill": "å‚é“ã§ã®è»½ã„ã‚¸ãƒ§ã‚®ãƒ³ã‚°ã‚„ã€éŸ³æ¥½ã«åˆã‚ã›ãŸãƒªã‚ºãƒ èµ°ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        "å³å¤§è…¿è§’åº¦å¤§_å·¦å¤§è…¿è§’åº¦å¤§": {
            "description": "ä¸¡è¶³ã¨ã‚‚ã‚ªãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã«ãªã£ã¦ãŠã‚Šã€å…¨ä½“çš„ã«éåŠ¹ç‡ãªèµ°ã‚Šæ–¹ã«ãªã£ã¦ã„ã¾ã™ã€‚",
            "action": "ä¸¡è¶³ã¨ã‚‚ç€åœ°ä½ç½®ã‚’ä½“ã®çœŸä¸‹ã«è¿‘ã¥ã‘ã€ãƒ”ãƒƒãƒé‡è¦–ã®èµ°ã‚Šæ–¹ã«å¤‰æ›´ã—ã¾ã—ã‚‡ã†ã€‚",
            "drill": "ä¸¡è¶³ã§ã®ã‚‚ã‚‚ä¸Šã’é‹å‹•ã¨ã€çŸ­ã„æ­©å¹…ã§ã®é«˜ãƒ”ãƒƒãƒèµ°ç·´ç¿’ã‚’çµ„ã¿åˆã‚ã›ã¾ã—ã‚‡ã†ã€‚"
        },
        "å³ä¸‹è…¿è§’åº¦å¤§_å·¦ä¸‹è…¿è§’åº¦å¤§": {
            "description": "ä¸¡è¶³ã¨ã‚‚è¶³å…ˆã§ã®ç€åœ°ãŒå¤šãã€ãµãã‚‰ã¯ãã¸ã®è² æ‹…ãŒå¤§ãããªã£ã¦ã„ã¾ã™ã€‚",
            "action": "ä¸¡è¶³ã¨ã‚‚ãƒŸãƒƒãƒ‰ãƒ•ãƒƒãƒˆï¼ˆè¶³ã®ä¸­å¤®éƒ¨ï¼‰ã§ã®ç€åœ°ã‚’æ„è­˜ã—ã€å…¨ä½“é‡ã‚’è¶³è£ã§å—ã‘æ­¢ã‚ã¾ã—ã‚‡ã†ã€‚",
            "drill": "è£¸è¶³ã§ã®ã‚†ã£ãã‚Šèµ°ã‚Šã‚„ã€èŠç”Ÿã®ä¸Šã§ã®æ„Ÿè¦šé‡è¦–ã®ç·´ç¿’ãŒåŠ¹æœçš„ã§ã™ã€‚"
        },
        
        # å…¨ä½“çš„ãªãƒãƒ©ãƒ³ã‚¹æ”¹å–„
        "ãƒ•ã‚©ãƒ¼ãƒ å…¨èˆ¬": {
            "description": "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ å…¨èˆ¬ã«æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã€ç·åˆçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¿…è¦ã§ã™ã€‚",
            "action": "åŸºæœ¬çš„ãªå§¿å‹¢ã‹ã‚‰è¦‹ç›´ã—ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸçŠ¶æ…‹ã§åŠ¹ç‡çš„ãªå‹•ãã‚’èº«ã«ã¤ã‘ã¾ã—ã‚‡ã†ã€‚",
            "drill": "ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ãƒ‰ãƒªãƒ«ã€åŸºæœ¬çš„ãªä½“å¹¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ã‚†ã£ãã‚Šã¨ã—ãŸã‚¸ãƒ§ã‚®ãƒ³ã‚°ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ã€‚"
        }
    }
    return advice_db

async def generate_detailed_advice_for_issue(issue: str, main_finding: str = None) -> dict:
    """
    å€‹åˆ¥ã®èª²é¡Œã«å¯¾ã—ã¦Gemini AIã‚’ä½¿ã£ã¦è©³ç´°ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã™ã‚‹
    
    Args:
        issue: å€‹åˆ¥ã®èª²é¡Œï¼ˆä¾‹: "å·¦ä¸‹è…¿è§’åº¦å¤§"ï¼‰
        main_finding: æ ¹æœ¬çš„ãªèª²é¡Œï¼ˆä¾‹: "ã‚ªãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰"ï¼‰
        
    Returns:
        è©³ç´°ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹è¾æ›¸
    """
    try:
        # main_findingãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã‚ˆã‚Šå…·ä½“çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
        if main_finding:
            prompt = f"""
ã‚ãªãŸã¯å°‚é–€ã‚³ãƒ¼ãƒã§ã™ã€‚{main_finding}ã®åŸå› ã§ã‚ã‚‹ã€Œ{issue}ã€ã«ã¤ã„ã¦ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

é‡è¦ï¼šè£…é£¾è¨˜å·ã¯ä¸€åˆ‡ä½¿ç”¨ç¦æ­¢ã§ã™ã€‚é€šå¸¸ã®æ–‡ç« ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

èª¬æ˜: {issue}ãŒ{main_finding}ã‚’å¼•ãèµ·ã“ã™ç†ç”±ã‚’ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹ç‡ã®è¦³ç‚¹ã‹ã‚‰80æ–‡å­—ç¨‹åº¦ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º: {issue}ã‚’æ”¹å–„ã™ã‚‹å…·ä½“çš„ãªç·´ç¿’æ–¹æ³•ã‚’60æ–‡å­—ç¨‹åº¦ã§ææ¡ˆã—ã¦ãã ã•ã„ã€‚

å½¢å¼ä¾‹ï¼š
èª¬æ˜: ä¸‹è…¿è§’åº¦ãŒå¤§ãã„ã¨æ¥åœ°æ™‚ã«ãƒ–ãƒ¬ãƒ¼ã‚­ãŒã‹ã‹ã‚Šã€æ¨é€²åŠ›ãŒæ¸›å°‘ã—ã¦ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹ç‡ãŒæ‚ªåŒ–ã—ã¾ã™ã€‚
ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º: å£ãƒ‰ãƒªãƒ«ã§è¶³ã®å¼•ãä¸Šã’ã‚’ç·´ç¿’ã—ã€é‡å¿ƒã®çœŸä¸‹ã§ç€åœ°ã™ã‚‹æ„Ÿè¦šã‚’ç¿’å¾—ã—ã¾ã—ã‚‡ã†ã€‚

ã“ã®ã‚ˆã†ãªé€šå¸¸ã®æ–‡ç« å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚ãƒãƒƒã‚·ãƒ¥ã€ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã€ãƒã‚¤ãƒ•ãƒ³ãªã©ã®è¨˜å·ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
"""
        else:
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            prompt = f"""
ã‚ãªãŸã¯å°‚é–€ã‚³ãƒ¼ãƒã§ã™ã€‚{issue}ã«ã¤ã„ã¦ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

é‡è¦ï¼šè£…é£¾è¨˜å·ã¯ä¸€åˆ‡ä½¿ç”¨ç¦æ­¢ã§ã™ã€‚é€šå¸¸ã®æ–‡ç« ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

èª¬æ˜: {issue}ãŒãƒ©ãƒ³ãƒ‹ãƒ³ã‚°åŠ¹ç‡ã«ä¸ãˆã‚‹å½±éŸ¿ã‚’80æ–‡å­—ç¨‹åº¦ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º: {issue}ã‚’æ”¹å–„ã™ã‚‹å…·ä½“çš„ãªç·´ç¿’æ–¹æ³•ã‚’60æ–‡å­—ç¨‹åº¦ã§ææ¡ˆã—ã¦ãã ã•ã„ã€‚

å½¢å¼ä¾‹ï¼š
èª¬æ˜: ä¸‹è…¿è§’åº¦ãŒå¤§ãã„ã¨æ¥åœ°æ™‚ã«ãƒ–ãƒ¬ãƒ¼ã‚­ãŒã‹ã‹ã‚Šã€æ¨é€²åŠ›ãŒæ¸›å°‘ã—ã¦ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹ç‡ãŒæ‚ªåŒ–ã—ã¾ã™ã€‚
ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º: å£ãƒ‰ãƒªãƒ«ã§è¶³ã®å¼•ãä¸Šã’ã‚’ç·´ç¿’ã—ã€é‡å¿ƒã®çœŸä¸‹ã§ç€åœ°ã™ã‚‹æ„Ÿè¦šã‚’ç¿’å¾—ã—ã¾ã—ã‚‡ã†ã€‚

ã“ã®ã‚ˆã†ãªé€šå¸¸ã®æ–‡ç« å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚ãƒãƒƒã‚·ãƒ¥ã€ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã€ãƒã‚¤ãƒ•ãƒ³ãªã©ã®è¨˜å·ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
"""

        # Gemini APIã‚’å‘¼ã³å‡ºã—ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œï¼‰
        if not USE_GEMINI_API or model is None:
            # APIã‚­ãƒ¼ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿”ã™
            print(f"   âš ï¸  Gemini APIã‚­ãƒ¼æœªè¨­å®š - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä½¿ç”¨")
            advice_db = get_advice_database()
            if issue in advice_db:
                default_advice = advice_db[issue]
                return {
                    "title": issue,
                    "description": default_advice.get("description", ""),
                    "action": default_advice.get("action", ""),
                    "drill": default_advice.get("drill", "")
                }
            else:
                return {
                    "title": issue,
                    "description": f"{issue}ã«ã¤ã„ã¦æ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚",
                    "action": "åŠ¹ç‡çš„ãªãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚",
                    "drill": "å®šæœŸçš„ãªç·´ç¿’ã§æ”¹å–„ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚"
                }
        
        print(f"   ğŸ“¡ Gemini APIå‘¼ã³å‡ºã—ä¸­... (modelå¤‰æ•°: {type(model)})")
        print(f"   ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {prompt[:100]}...")
        
        # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ: è¤‡æ•°å›ãƒªãƒˆãƒ©ã‚¤
        max_retries = 3
        for attempt in range(max_retries):
            try:
                response = model.generate_content(prompt)
                print(f"   ğŸ“¨ Geminiå¿œç­”å—ä¿¡: {type(response)}")
                break
            except Exception as api_error:
                error_str = str(api_error)
                if "429" in error_str or "quota" in error_str.lower():
                    if attempt < max_retries - 1:
                        wait_time = (attempt + 1) * 10  # 10ç§’, 20ç§’, 30ç§’ã®é–“éš”
                        print(f"   â³ ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ¤œå‡ºã€{wait_time}ç§’å¾…æ©Ÿå¾Œã«ãƒªãƒˆãƒ©ã‚¤ ({attempt + 1}/{max_retries})")
                        await asyncio.sleep(wait_time)
                        continue
                    else:
                        print(f"   âŒ æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚")
                        raise api_error
                elif "500" in error_str or "InternalServerError" in error_str:
                    # Gemini APIå´ã®ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼
                    if attempt < max_retries - 1:
                        wait_time = (attempt + 1) * 5  # 5ç§’, 10ç§’, 15ç§’ã®é–“éš”
                        print(f"   â³ Gemini APIå†…éƒ¨ã‚¨ãƒ©ãƒ¼ã€{wait_time}ç§’å¾…æ©Ÿå¾Œã«ãƒªãƒˆãƒ©ã‚¤ ({attempt + 1}/{max_retries})")
                        await asyncio.sleep(wait_time)
                        continue
                    else:
                        print(f"   âŒ Gemini APIå†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç¶™ç¶šã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚")
                        raise api_error
                else:
                    raise api_error
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
        if response and response.candidates:
            candidate = response.candidates[0]
            if candidate.finish_reason == 2:  # SAFETY
                print(f"   âš ï¸  å®‰å…¨æ€§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ: {issue}")
                advice_text = "ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã®ãŸã‚ã®ä¸€èˆ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚"
            elif hasattr(response, 'text') and response.text:
                advice_text = response.text.strip()
                print(f"   ğŸ“„ Geminiå€‹åˆ¥è§£èª¬ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ({issue}): {advice_text[:200]}...")  # ãƒ‡ãƒãƒƒã‚°ç”¨
                print(f"   ğŸ” å®Œå…¨ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹: {repr(advice_text)}")  # å®Œå…¨ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‡ãƒãƒƒã‚°
            else:
                print(f"   âš ï¸  ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™: {issue}")
                advice_text = "ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã®ãŸã‚ã®ä¸€èˆ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚"
        elif response and hasattr(response, 'text') and response.text:
            advice_text = response.text.strip()
            print(f"   ğŸ“„ Geminiå€‹åˆ¥è§£èª¬ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ({issue}): {advice_text[:200]}...")  # ãƒ‡ãƒãƒƒã‚°ç”¨
            print(f"   ğŸ” å®Œå…¨ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹: {repr(advice_text)}")  # å®Œå…¨ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‡ãƒãƒƒã‚°
            
            # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’å¾¹åº•çš„ã«é™¤å»
            import re
            cleaned_text = advice_text
            
            # ãƒ˜ãƒƒãƒ€ãƒ¼è¨˜æ³•ã‚’é™¤å»ï¼ˆ##### ã‚‚å«ã‚€ï¼‰
            cleaned_text = re.sub(r'#{1,6}\s*', '', cleaned_text)
            
            # å¼·èª¿è¨˜æ³•ã‚’é™¤å»
            cleaned_text = re.sub(r'\*\*(.*?)\*\*', r'\1', cleaned_text)  # **å¤ªå­—**
            cleaned_text = re.sub(r'\*(.*?)\*', r'\1', cleaned_text)      # *ã‚¤ã‚¿ãƒªãƒƒã‚¯*
            
            # åŒºåˆ‡ã‚Šç·šã‚’é™¤å»
            cleaned_text = re.sub(r'^-{3,}$', '', cleaned_text, flags=re.MULTILINE)
            cleaned_text = re.sub(r'^_{3,}$', '', cleaned_text, flags=re.MULTILINE)
            
            # ãƒªã‚¹ãƒˆè¨˜æ³•ã‚’é™¤å»
            cleaned_text = re.sub(r'^\s*[-*+]\s+', '', cleaned_text, flags=re.MULTILINE)
            
            # ç•ªå·ä»˜ããƒªã‚¹ãƒˆã‚’é™¤å»
            cleaned_text = re.sub(r'^\s*\d+\.\s+', '', cleaned_text, flags=re.MULTILINE)
            
            # è¡¨è¨˜æ³•ã‚’é™¤å»
            cleaned_text = re.sub(r'\|', '', cleaned_text)
            cleaned_text = re.sub(r':---', '', cleaned_text)
            
            # å¼•ç”¨è¨˜æ³•ã‚’é™¤å»
            cleaned_text = re.sub(r'^>\s*', '', cleaned_text, flags=re.MULTILINE)
            
            # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’é™¤å»
            cleaned_text = re.sub(r'`([^`]+)`', r'\1', cleaned_text)
            
            # æ”¹è¡Œã‚’æ•´ç†
            cleaned_text = re.sub(r'\n{3,}', '\n\n', cleaned_text)
            cleaned_text = cleaned_text.strip()
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æã—ã¦æ§‹é€ åŒ–
            lines = advice_text.split('\n')
            explanation = ""
            exercise = ""
            
            # æ”¹è‰¯ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
            explanation = ""
            exercise = ""
            
            # æ®µè½ãƒ™ãƒ¼ã‚¹ã§ã®è§£æï¼ˆã‚¯ãƒªãƒ¼ãƒ³ãªãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ï¼‰
            paragraphs = [p.strip() for p in cleaned_text.split('\n') if p.strip()]
            
            # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®åˆ†é¡
            explanation_lines = []
            exercise_lines = []
            current_section = "explanation"
            
            for paragraph in paragraphs:
                # ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®š
                if any(keyword in paragraph for keyword in ['ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º', 'ç·´ç¿’', 'ãƒ‰ãƒªãƒ«', 'é‹å‹•', 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°']):
                    current_section = "exercise"
                elif any(keyword in paragraph for keyword in ['èª¬æ˜', 'å½±éŸ¿', 'å•é¡Œ', 'åŸå› ', 'åŠ¹æœ']):
                    current_section = "explanation"
                
                # ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã«åˆ†é¡
                if current_section == "exercise":
                    exercise_lines.append(paragraph)
                else:
                    explanation_lines.append(paragraph)
            
            # çµæœã‚’ã¾ã¨ã‚ã‚‹
            explanation = ' '.join(explanation_lines).strip()
            exercise = ' '.join(exercise_lines).strip()
            
            # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            explanation = explanation.replace('èª¬æ˜:', '').replace('èª¬æ˜ï¼š', '').strip()
            exercise = exercise.replace('ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º:', '').replace('ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºï¼š', '').strip()
            
            # æœ€ä½é™ã®å“è³ªä¿è¨¼ï¼ˆcleanedTextã‚’ä½¿ç”¨ï¼‰
            if len(explanation) < 20:  # èª¬æ˜ãŒçŸ­ã™ãã‚‹å ´åˆ
                explanation = cleaned_text[:len(cleaned_text)//2] if cleaned_text else "ã“ã®èª²é¡Œã¯èµ°è¡ŒåŠ¹ç‡ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            if len(exercise) < 15:  # ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãŒçŸ­ã™ãã‚‹å ´åˆ
                exercise = cleaned_text[len(cleaned_text)//2:] if cleaned_text else "åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ ç·´ç¿’ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚"
            
            # æœ€çµ‚çš„ãªãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³é™¤å»ï¼ˆå¿µã®ãŸã‚ï¼‰
            def clean_markdown_text(text):
                if not text:
                    return text
                # ãƒ˜ãƒƒãƒ€ãƒ¼è¨˜æ³•ã‚’é™¤å»
                text = text.replace('###', '').replace('##', '').replace('#', '')
                # å¼·èª¿è¨˜æ³•ã‚’é™¤å»
                text = text.replace('**', '').replace('*', '')
                # åŒºåˆ‡ã‚Šç·šã‚’é™¤å»
                text = text.replace('---', '').replace('___', '')
                # ãƒªã‚¹ãƒˆè¨˜æ³•ã‚’é™¤å»
                text = text.replace('- ', '').replace('* ', '').replace('+ ', '')
                # ç•ªå·ä»˜ããƒªã‚¹ãƒˆã‚’é™¤å»
                import re
                text = re.sub(r'^\d+\.\s+', '', text, flags=re.MULTILINE)
                # è¡¨è¨˜æ³•ã‚’é™¤å»
                text = text.replace('|', '')
                # æ”¹è¡Œã‚’æ•´ç†
                text = text.replace('\n\n\n', '\n\n')
                return text.strip()
            
            explanation = clean_markdown_text(explanation)
            exercise = clean_markdown_text(exercise)
            
            print(f"   ğŸ¯ æœ€çµ‚çµæœ - èª¬æ˜: '{explanation[:100]}...' ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º: '{exercise[:100]}...'")
            
            return {
                "issue": issue,
                "explanation": explanation or "ã“ã®èª²é¡Œã¯èµ°è¡ŒåŠ¹ç‡ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
                "exercise": exercise or "åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ ç·´ç¿’ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚"
            }
        else:
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            return {
                "issue": issue,
                "explanation": "ã“ã®èª²é¡Œã¯èµ°è¡ŒåŠ¹ç‡ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
                "exercise": "åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ ç·´ç¿’ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚"
            }
            
    except Exception as e:
        import traceback
        print(f"   âš ï¸  å€‹åˆ¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ ({issue}): {str(e)}")
        print(f"   ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: {type(e).__name__}")
        print(f"   ğŸ“ ãƒˆãƒ¬ãƒ¼ã‚¹ãƒãƒƒã‚¯:")
        traceback.print_exc()
        return {
            "issue": issue,
            "explanation": "ã“ã®èª²é¡Œã¯èµ°è¡ŒåŠ¹ç‡ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "exercise": "åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ ç·´ç¿’ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚"
        }

def generate_advanced_advice(issues_list: List[str]) -> str:
    """
    è¤‡æ•°ã®èª²é¡Œã‚’è€ƒæ…®ã—ãŸé«˜ãƒ¬ãƒ™ãƒ«ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã™ã‚‹
    
    Args:
        issues_list: Zå€¤åˆ¤å®šãªã©ã«ã‚ˆã£ã¦ç‰¹å®šã•ã‚ŒãŸèª²é¡Œã®ãƒªã‚¹ãƒˆ
        
    Returns:
        ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæœ€çµ‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ–‡å­—åˆ—
    """
    advice_db = get_advice_database()
    
    if not issues_list:
        # èª²é¡ŒãŒãªã„å ´åˆã¯ä¸€èˆ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿”ã™
        selected_advice = advice_db["ãƒ•ã‚©ãƒ¼ãƒ å…¨èˆ¬"]
    else:
        # èª²é¡Œã®çµ„ã¿åˆã‚ã›ã‚’ç¢ºèª
        issues_key = "_".join(sorted(issues_list))
        
        # è¤‡åˆçš„ãªèª²é¡ŒãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if issues_key in advice_db:
            selected_advice = advice_db[issues_key]
        else:
            # è¤‡åˆçš„ãªèª²é¡ŒãŒãªã„å ´åˆã€å„ªå…ˆåº¦é †ã§å˜ä¸€èª²é¡Œã‚’é¸æŠ
            priority_order = [
                "å¤§è…¿è§’åº¦å¤§_ä¸‹è…¿è§’åº¦å¤§", "ä½“å¹¹å‰å‚¾_ä¸Šä¸‹å‹•å¤§", "ä½“å¹¹å¾Œå‚¾_ãƒ”ãƒƒãƒä½",
                "å³å¤§è…¿è§’åº¦å¤§_å·¦å¤§è…¿è§’åº¦å¤§", "å³ä¸‹è…¿è§’åº¦å¤§_å·¦ä¸‹è…¿è§’åº¦å¤§",
                "ä½“å¹¹å¾Œå‚¾", "ä½“å¹¹å‰å‚¾", "ä¸Šä¸‹å‹•å¤§", "ãƒ”ãƒƒãƒä½", "ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰é•·",
                "å³å¤§è…¿è§’åº¦å¤§", "å·¦å¤§è…¿è§’åº¦å¤§", "å³ä¸‹è…¿è§’åº¦å¤§", "å·¦ä¸‹è…¿è§’åº¦å¤§"
            ]
            
            selected_advice = None
            for priority_issue in priority_order:
                if priority_issue in issues_list and priority_issue in advice_db:
                    selected_advice = advice_db[priority_issue]
                    break
            
            # ã©ã®å„ªå…ˆèª²é¡Œã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€åˆã®èª²é¡Œã‚’ä½¿ç”¨
            if not selected_advice and issues_list:
                first_issue = issues_list[0]
                if first_issue in advice_db:
                    selected_advice = advice_db[first_issue]
                else:
                    selected_advice = advice_db["ãƒ•ã‚©ãƒ¼ãƒ å…¨èˆ¬"]
            
            # ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä¸€èˆ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹
            if not selected_advice:
                selected_advice = advice_db["ãƒ•ã‚©ãƒ¼ãƒ å…¨èˆ¬"]
    
    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
    formatted_advice = f"""--- ğŸƒâ€â™‚ï¸ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ ---

ã€ğŸ“Š ç¾çŠ¶ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã¤ã„ã¦ã€‘
{selected_advice['description']}

ã€ğŸ¯ æ”¹å–„ã®ãŸã‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘
{selected_advice['action']}

ã€ğŸ’ª ãŠã™ã™ã‚ã®è£œå¼·ãƒ‰ãƒªãƒ«ã€‘
{selected_advice['drill']}

ã€ğŸ’¡ ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘
æ”¹å–„ã¯ä¸€åº¦ã«å…¨ã¦ã‚’å¤‰ãˆã‚ˆã†ã¨ã›ãšã€ä¸€ã¤ãšã¤æ®µéšçš„ã«å–ã‚Šçµ„ã‚€ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚ã¾ãšã¯æ„è­˜ã‚’å¤‰ãˆã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¦ã€å¾ã€…ã«ä½“ã«è¦šãˆã•ã›ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
"""
    
    return formatted_advice

def get_fallback_advice_for_issue(issue: str) -> Dict[str, str]:
    """
    Gemini APIå¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›
    
    Args:
        issue: èª²é¡Œå
        
    Returns:
        ã‚¢ãƒ‰ãƒã‚¤ã‚¹è¾æ›¸
    """
    fallback_db = {
        "å·¦ä¸‹è…¿è§’åº¦ä¸­": {
            "issue": "å·¦ä¸‹è…¿è§’åº¦ä¸­",
            "explanation": "å·¦è¶³ã®ä¸‹è…¿ï¼ˆã™ã­ï¼‰ã®è§’åº¦ãŒä¸­ç¨‹åº¦ã®åå·®ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚èµ°è¡Œæ™‚ã®ãƒãƒ©ãƒ³ã‚¹ã‚„ç€åœ°ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è»½å¾®ãªå½±éŸ¿ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "exercise": "ç‰‡è¶³ç«‹ã¡ãƒãƒ©ãƒ³ã‚¹ç·´ç¿’ã‚’å·¦è¶³ä¸­å¿ƒã«å®Ÿæ–½ã—ã€ä½“å¹¹ã‚’å®‰å®šã•ã›ãªãŒã‚‰æ­£ç¢ºãªç€åœ°ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚"
        },
        "å³ä¸‹è…¿è§’åº¦å¤§": {
            "issue": "å³ä¸‹è…¿è§’åº¦å¤§",
            "explanation": "å³è¶³ã®ä¸‹è…¿ï¼ˆã™ã­ï¼‰ã®è§’åº¦ãŒåŸºæº–å€¤ã‹ã‚‰å¤§ããåå·®ã—ã¦ã„ã¾ã™ã€‚ã‚ªãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚„ä¸åŠ¹ç‡ãªç€åœ°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åŸå› ã¨ãªã‚Šã€æ€ªæˆ‘ã®ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "exercise": "çŸ­ã„æ­©å¹…ã§ã®é«˜é »åº¦ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ç·´ç¿’ï¼ˆãƒ”ãƒƒãƒã‚¢ãƒƒãƒ—ãƒ‰ãƒªãƒ«ï¼‰ã‚’å®Ÿæ–½ã—ã€è¶³ã®å›è»¢ã‚’æ„è­˜ã—ãŸèµ°æ³•ã‚’èº«ã«ã¤ã‘ã¦ãã ã•ã„ã€‚"
        },
        "å·¦å¤§è…¿è§’åº¦ä¸­": {
            "issue": "å·¦å¤§è…¿è§’åº¦ä¸­",
            "explanation": "å·¦è¶³ã®å¤§è…¿éƒ¨ã®è§’åº¦ãŒä¸­ç¨‹åº¦ã®åå·®ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚è‚¡é–¢ç¯€ã®å¯å‹•åŸŸã‚„æ¨é€²åŠ›ã®ç™ºæ®ã«è»½å¾®ãªå½±éŸ¿ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "exercise": "ãƒ©ãƒ³ã‚¸ã‚„ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆã§è‚¡é–¢ç¯€ã®å¯å‹•åŸŸã‚’å‘ä¸Šã•ã›ã€å¤§è…¿å››é ­ç­‹ã¨ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ•´ãˆã¦ãã ã•ã„ã€‚"
        },
        "å·¦ä¸‹è…¿è§’åº¦å¤§": {
            "issue": "å·¦ä¸‹è…¿è§’åº¦å¤§",
            "explanation": "å·¦è¶³ã®ä¸‹è…¿ï¼ˆã™ã­ï¼‰ã®è§’åº¦ãŒåŸºæº–å€¤ã‹ã‚‰å¤§ããåå·®ã—ã¦ã„ã¾ã™ã€‚ç€åœ°æ™‚ã®è¡æ’ƒãŒéå¤§ã«ãªã‚Šã€ã‚·ãƒ³ã‚¹ãƒ—ãƒªãƒ³ãƒˆãªã©ã®æ€ªæˆ‘ã®ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            "exercise": "ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚ºã¨ã¤ã¾å…ˆæ­©ãã§ä¸‹è…¿éƒ¨ã®ç­‹åŠ›ã‚’å¼·åŒ–ã—ã€æ­£ã—ã„ç€åœ°è§’åº¦ã‚’èº«ã«ã¤ã‘ã‚‹ç·´ç¿’ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚"
        }
    }
    
    # èª²é¡Œã«å¯¾å¿œã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—
    if issue in fallback_db:
        return fallback_db[issue]
    
    # æ±ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return {
        "issue": issue,
        "explanation": f"{issue}ã«é–¢ã—ã¦æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚é©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒ èª¿æ•´ã«ã‚ˆã‚Šã€èµ°è¡ŒåŠ¹ç‡ã®å‘ä¸Šã¨æ€ªæˆ‘äºˆé˜²ã«åŠ¹æœãŒæœŸå¾…ã§ãã¾ã™ã€‚",
        "exercise": "åŸºæœ¬çš„ãªãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ‰ãƒªãƒ«ã¨ãƒãƒ©ãƒ³ã‚¹ç·´ç¿’ã‚’ç¶™ç¶šã—ã€æ®µéšçš„ã«ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã«å–ã‚Šçµ„ã‚“ã§ãã ã•ã„ã€‚"
    }

def identify_main_finding(issues_list: List[str]) -> str:
    """
    èª²é¡Œãƒªã‚¹ãƒˆã‹ã‚‰æ ¹æœ¬çš„ãªå•é¡Œã‚’ç‰¹å®šã™ã‚‹
    
    Args:
        issues_list: æ¤œå‡ºã•ã‚ŒãŸèª²é¡Œã®ãƒªã‚¹ãƒˆ
        
    Returns:
        æ ¹æœ¬èª²é¡Œã®åç§°
    """
    # å¤§è…¿è§’åº¦å¤§ã‚„ä¸‹è…¿è§’åº¦å¤§ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯ã‚ªãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰
    thigh_calf_issues = [issue for issue in issues_list if "å¤§è…¿è§’åº¦å¤§" in issue or "ä¸‹è…¿è§’åº¦å¤§" in issue]
    if len(thigh_calf_issues) >= 2:
        return "ã‚ªãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰"
    
    # ä½“å¹¹é–¢é€£ã®å•é¡ŒãŒã‚ã‚‹å ´åˆ
    trunk_issues = [issue for issue in issues_list if "ä½“å¹¹" in issue]
    if trunk_issues:
        if "ä½“å¹¹å¾Œå‚¾" in trunk_issues:
            return "ä½“å¹¹å¾Œå‚¾ãƒ•ã‚©ãƒ¼ãƒ "
        elif "ä½“å¹¹å‰å‚¾" in trunk_issues:
            return "ä½“å¹¹å‰å‚¾ãƒ•ã‚©ãƒ¼ãƒ "
        else:
            return "ä½“å¹¹å§¿å‹¢ã®å•é¡Œ"
    
    # ä¸Šä¸‹å‹•ã‚„ãƒ”ãƒƒãƒã®å•é¡Œ
    if "ä¸Šä¸‹å‹•å¤§" in issues_list:
        return "ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹ç‡ã®ä½ä¸‹"
    
    if "ãƒ”ãƒƒãƒä½" in issues_list:
        return "ãƒ”ãƒƒãƒä¸è¶³"
    
    # ãã®ä»–ã®å ´åˆã¯ä¸€èˆ¬çš„ãªè¡¨ç¾
    if issues_list:
        return "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã®åŠ¹ç‡æ€§"
    else:
        return "ãƒ•ã‚©ãƒ¼ãƒ å…¨èˆ¬"

async def generate_integrated_advice(issues_list: List[str]) -> str:
    """
    ãƒ—ãƒ­ã‚³ãƒ¼ãƒã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã¨Gemini AIè©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’çµ±åˆã™ã‚‹
    
    Args:
        issues_list: Zå€¤åˆ¤å®šãªã©ã«ã‚ˆã£ã¦ç‰¹å®šã•ã‚ŒãŸèª²é¡Œã®ãƒªã‚¹ãƒˆ
        
    Returns:
        çµ±åˆã•ã‚ŒãŸæœ€çµ‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ–‡å­—åˆ—
    """
    try:
        print(f"   ğŸ”„ çµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆé–‹å§‹ - èª²é¡Œæ•°: {len(issues_list)}")
        
        # 1. æ ¹æœ¬èª²é¡Œï¼ˆmain_findingï¼‰ã‚’ç‰¹å®š
        main_finding = identify_main_finding(issues_list)
        print(f"   ğŸ¯ æ ¹æœ¬èª²é¡Œç‰¹å®š: {main_finding}")
        
        # 2. ãƒ—ãƒ­ã‚³ãƒ¼ãƒã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ
        coach_advice = generate_advanced_advice(issues_list)
        print(f"   âœ… ãƒ—ãƒ­ã‚³ãƒ¼ãƒã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆå®Œäº†")
        
        # 3. å€‹åˆ¥èª²é¡Œã®è©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’AIã§ç”Ÿæˆï¼ˆæ ¹æœ¬èª²é¡Œã‚’é–¢é€£ä»˜ã‘ï¼‰
        detailed_advices = []
        for issue in issues_list:
            if issue and issue.strip():
                print(f"   ğŸ¤– AIè©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆä¸­: {issue.strip()}")
                try:
                    # Gemini APIã‚’ä½¿ç”¨ã—ã¦ã‚ˆã‚Šè©³ç´°ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ
                    detailed_advice = await generate_detailed_advice_for_issue(issue.strip(), main_finding)
                    detailed_advices.append(detailed_advice)
                    print(f"   âœ… AIè©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆå®Œäº†: {issue.strip()}")
                except Exception as ai_error:
                    print(f"   âš ï¸ AIè©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆå¤±æ•—: {ai_error}, ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨")
                    # AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆã¯è©³ç´°ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    fallback_advice = get_fallback_advice_for_issue(issue.strip())
                    detailed_advices.append(fallback_advice)
        
        print(f"   âœ… å€‹åˆ¥è©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆå®Œäº† - {len(detailed_advices)}ä»¶")
        
        # 4. çµ±åˆã•ã‚ŒãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’çµ„ã¿ç«‹ã¦
        integrated_text = f"""{coach_advice}

ã€å€‹åˆ¥èª²é¡Œã®è©³ç´°è§£èª¬ã€‘"""
        
        for i, advice in enumerate(detailed_advices, 1):
            issue_name = advice['issue']
            explanation = advice['explanation']
            exercise = advice['exercise']
            
            # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’æœ€çµ‚çš„ã«é™¤å»
            def final_clean_markdown(text):
                if not text:
                    return text
                import re
                
                # ãƒ˜ãƒƒãƒ€ãƒ¼è¨˜æ³•ã‚’å¾¹åº•çš„ã«é™¤å»
                text = re.sub(r'#{1,6}\s*', '', text)
                
                # å¼·èª¿è¨˜æ³•ã‚’é™¤å»ï¼ˆå¤ªå­—ãƒ»ã‚¤ã‚¿ãƒªãƒƒã‚¯ï¼‰
                text = re.sub(r'\*\*(.*?)\*\*', r'\1', text)  # **å¤ªå­—**
                text = re.sub(r'\*(.*?)\*', r'\1', text)      # *ã‚¤ã‚¿ãƒªãƒƒã‚¯*
                text = re.sub(r'__(.*?)__', r'\1', text)      # __å¤ªå­—__
                text = re.sub(r'_(.*?)_', r'\1', text)        # _ã‚¤ã‚¿ãƒªãƒƒã‚¯_
                
                # åŒºåˆ‡ã‚Šç·šã‚’é™¤å»
                text = re.sub(r'^-{3,}.*$', '', text, flags=re.MULTILINE)
                text = re.sub(r'^_{3,}.*$', '', text, flags=re.MULTILINE)
                text = re.sub(r'^\*{3,}.*$', '', text, flags=re.MULTILINE)
                
                # ãƒªã‚¹ãƒˆè¨˜æ³•ã‚’é™¤å»
                text = re.sub(r'^\s*[-*+]\s+', '', text, flags=re.MULTILINE)
                
                # ç•ªå·ä»˜ããƒªã‚¹ãƒˆã‚’é™¤å»
                text = re.sub(r'^\s*\d+\.\s+', '', text, flags=re.MULTILINE)
                
                # è¡¨è¨˜æ³•ã‚’å¾¹åº•çš„ã«é™¤å»
                text = re.sub(r'\|.*?\|', '', text)  # |ãƒ†ãƒ¼ãƒ–ãƒ«|
                text = re.sub(r'\|', '', text)
                text = re.sub(r':---:?', '', text)
                text = re.sub(r'---:', '', text)
                
                # å¼•ç”¨è¨˜æ³•ã‚’é™¤å»
                text = re.sub(r'^>\s*', '', text, flags=re.MULTILINE)
                
                # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’é™¤å»
                text = re.sub(r'`([^`]+)`', r'\1', text)
                
                # ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»
                text = re.sub(r'```.*?```', '', text, flags=re.DOTALL)
                
                # æ®‹ã‚Šã®è¨˜å·ã‚’é™¤å»
                text = re.sub(r'[#*_`~]', '', text)
                
                # æ”¹è¡Œã‚’æ•´ç†
                text = re.sub(r'\n{3,}', '\n\n', text)
                
                return text.strip()
            
            explanation = final_clean_markdown(explanation)
            exercise = final_clean_markdown(exercise)
            
            # ãƒ†ã‚­ã‚¹ãƒˆé‡è¤‡ã®é˜²æ­¢: exerciseãŒã€Œæ¨å¥¨ã€ã§å§‹ã¾ã‚‹å ´åˆã¯ã€Œæ¨å¥¨ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º: ã€ã‚’è¿½åŠ ã—ãªã„
            if exercise.strip().startswith('æ¨å¥¨'):
                exercise_display = f"   {exercise}"
            else:
                exercise_display = f"   æ¨å¥¨ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º: {exercise}"
            
            integrated_text += f"""

{i}. {issue_name}
   è©³ç´°: {explanation}
{exercise_display}"""
        
        integrated_text += """

ã€ç·åˆçš„ãªæ”¹å–„ã®ãƒã‚¤ãƒ³ãƒˆã€‘
æ”¹å–„ã¯æ®µéšçš„ã«å–ã‚Šçµ„ã‚€ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã¾ãšã¯å…¨ä½“çš„ãªãƒ•ã‚©ãƒ¼ãƒ æ„è­˜ã‹ã‚‰å§‹ã‚ã¦ã€å€‹åˆ¥ã®èª²é¡Œã«é †æ¬¡å¯¾å‡¦ã—ã¦ã„ãã“ã¨ã§ã€ã‚ˆã‚ŠåŠ¹æœçš„ãªãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚"""
        
        # æœ€çµ‚çš„ã«çµ±åˆãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‹ã‚‰ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’é™¤å»
        import re
        def complete_markdown_removal(text):
            if not text:
                return text
                
            # ãƒ˜ãƒƒãƒ€ãƒ¼è¨˜æ³•ã‚’é™¤å»
            text = re.sub(r'#{1,6}\s*', '', text)
            
            # å¼·èª¿è¨˜æ³•ã‚’é™¤å»
            text = re.sub(r'\*\*(.*?)\*\*', r'\1', text)  # **å¤ªå­—**
            text = re.sub(r'\*(.*?)\*', r'\1', text)      # *ã‚¤ã‚¿ãƒªãƒƒã‚¯*
            text = re.sub(r'__(.*?)__', r'\1', text)      # __å¤ªå­—__
            text = re.sub(r'_(.*?)_', r'\1', text)        # _ã‚¤ã‚¿ãƒªãƒƒã‚¯_
            
            # åŒºåˆ‡ã‚Šç·šã‚’é™¤å»
            text = re.sub(r'^-{3,}.*$', '', text, flags=re.MULTILINE)
            text = re.sub(r'^_{3,}.*$', '', text, flags=re.MULTILINE)
            text = re.sub(r'^\*{3,}.*$', '', text, flags=re.MULTILINE)
            
            # ãƒªã‚¹ãƒˆè¨˜æ³•ã‚’é™¤å»
            text = re.sub(r'^\s*[-*+]\s+', '', text, flags=re.MULTILINE)
            
            # ç•ªå·ä»˜ããƒªã‚¹ãƒˆã‚’é™¤å»
            text = re.sub(r'^\s*\d+\.\s+', '', text, flags=re.MULTILINE)
            
            # è¡¨è¨˜æ³•ã‚’å¾¹åº•çš„ã«é™¤å»
            text = re.sub(r'\|.*?\|.*?\|', '', text)  # |åˆ—1|åˆ—2|åˆ—3|å½¢å¼
            text = re.sub(r'\|.*?\|', '', text)       # |åˆ—1|åˆ—2|å½¢å¼
            text = re.sub(r'\|[^|\n]*', '', text)     # |ã§å§‹ã¾ã‚‹è¡Œ
            text = re.sub(r'[^|\n]*\|', '', text)     # |ã§çµ‚ã‚ã‚‹è¡Œ
            text = re.sub(r'\|', '', text)            # æ®‹ã£ãŸ|
            text = re.sub(r':---:?', '', text)
            text = re.sub(r'---:', '', text)
            
            # ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»
            text = re.sub(r'```.*?```', '', text, flags=re.DOTALL)
            
            # æ®‹ã‚Šã®è¨˜å·ã‚’é™¤å»
            text = re.sub(r'[#*_`~]', '', text)
            
            # æ”¹è¡Œã‚’æ•´ç†
            text = re.sub(r'\n{3,}', '\n\n', text)
            
            return text.strip()
        
        integrated_text = complete_markdown_removal(integrated_text)
        
        print(f"   ğŸ¯ çµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆå®Œäº† (é•·ã•: {len(integrated_text)} æ–‡å­—)")
        return integrated_text
        
    except Exception as e:
        print(f"   âŒ çµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {str(e)}")
        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ—ãƒ­ã‚³ãƒ¼ãƒã‚¢ãƒ‰ãƒã‚¤ã‚¹ + ç°¡æ˜“å€‹åˆ¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹
        try:
            coach_advice = generate_advanced_advice(issues_list)
            simple_details = []
            for issue in issues_list:
                if issue and issue.strip():
                    fallback_advice = get_fallback_advice_for_issue(issue.strip())
                    simple_details.append(f"\nâ€¢ {fallback_advice['issue']}: {fallback_advice['explanation']}")
            
            fallback_text = f"""{coach_advice}

ã€å€‹åˆ¥èª²é¡Œã®è©³ç´°è§£èª¬ã€‘
AIåˆ†æã«ã‚ˆã‚‹å…·ä½“çš„ãªæ”¹å–„ãƒã‚¤ãƒ³ãƒˆ
{''.join(simple_details)}

ã€ç·åˆçš„ãªæ”¹å–„ã®ãƒã‚¤ãƒ³ãƒˆã€‘
æ”¹å–„ã¯æ®µéšçš„ã«å–ã‚Šçµ„ã‚€ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã¾ãšã¯å…¨ä½“çš„ãªãƒ•ã‚©ãƒ¼ãƒ æ„è­˜ã‹ã‚‰å§‹ã‚ã¦ã€å€‹åˆ¥ã®èª²é¡Œã«é †æ¬¡å¯¾å‡¦ã—ã¦ã„ãã“ã¨ã§ã€ã‚ˆã‚ŠåŠ¹æœçš„ãªãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚"""
            
            return fallback_text
        except Exception as fallback_error:
            print(f"   âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã‚‚å¤±æ•—: {str(fallback_error)}")
            # æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            return """--- ğŸƒâ€â™‚ï¸ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ ---

ã€ğŸ“Š ç¾çŠ¶ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã¤ã„ã¦ã€‘
ã‚·ã‚¹ãƒ†ãƒ ã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã‚ãªãŸã®ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã®å‘ä¸Šã¸ã®å–ã‚Šçµ„ã¿ã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ æ„è­˜ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚

ã€ğŸ¯ æ”¹å–„ã®ãŸã‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘
æ­£ã—ã„å§¿å‹¢ã‚’ä¿ã¡ã€è‡ªç„¶ãªãƒªã‚ºãƒ ã§ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚æ€¥æ¿€ãªå¤‰åŒ–ã‚ˆã‚Šã‚‚æ®µéšçš„ãªæ”¹å–„ã‚’å¿ƒãŒã‘ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

ã€ğŸ’ª æ¨å¥¨ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã€‘
ç·´ç¿’ãƒ‰ãƒªãƒ«: ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸå§¿å‹¢ã§ã€è‡ªç„¶ãªãƒªã‚ºãƒ ã‚’ä¿ã¡ãªãŒã‚‰ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚

ã€ğŸ’¡ ç·åˆçš„ãªæ”¹å–„ã®ãƒã‚¤ãƒ³ãƒˆã€‘
æ”¹å–„ã¯æ®µéšçš„ã«å–ã‚Šçµ„ã‚€ã“ã¨ãŒé‡è¦ã§ã™ã€‚

ã¾ãšã¯å…¨ä½“çš„ãªãƒ•ã‚©ãƒ¼ãƒ æ„è­˜ã‹ã‚‰å§‹ã‚ã¦ã€å€‹åˆ¥ã®èª²é¡Œã«é †æ¬¡å¯¾å‡¦ã—ã¦ã„ãã“ã¨ã§ã€ã‚ˆã‚ŠåŠ¹æœçš„ãªãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚"""

def create_gemini_prompt(issues: List[str]) -> str:
    """Gemini APIã«é€ä¿¡ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ"""
    issues_text = "\n".join([f"- {issue}" for issue in issues])
    
    prompt = f"""ã‚ãªãŸã¯ã€ã‚¹ãƒãƒ¼ãƒ„ç§‘å­¦ã«åŸºã¥ããƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ åˆ†æã®å°‚é–€å®¶ã§ã‚ã‚Šã€ä¸–ç•Œãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ãƒ¼ãƒã§ã™ã€‚

ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ åˆ†æã«ãŠã„ã¦ä»¥ä¸‹ã®èª²é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚å„èª²é¡Œã«ã¤ã„ã¦ã€è©³ç´°ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€æ¤œå‡ºã•ã‚ŒãŸèª²é¡Œã€‘:
{issues_text}

ã€é‡è¦ã€‘ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã¯ä¸€åˆ‡ä½¿ç”¨ã›ãšã€ä»¥ä¸‹ã®è¦æ±‚ã«å¾“ã£ã¦ã€å¿…ãšJSONå½¢å¼ã®æ–‡å­—åˆ—"ã®ã¿"ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚```jsonãªã©ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚

{{
  "advices": [
    {{
      "title": "ï¼ˆèª²é¡Œåã«åŸºã¥ã„ãŸæ”¹å–„ã‚¿ã‚¤ãƒˆãƒ«ï¼‰",
      "description": "ï¼ˆèª²é¡Œã®å…·ä½“çš„å½±éŸ¿ã¨æ”¹å–„å¿…è¦æ€§ã‚’80-120æ–‡å­—ã§è©³ç´°ã«èª¬æ˜ã€‚ãªãœå•é¡Œãªã®ã‹ã€æ”¾ç½®ã—ãŸå ´åˆã®ãƒªã‚¹ã‚¯ã€æ”¹å–„ãƒ¡ãƒªãƒƒãƒˆã‚’å«ã‚ã‚‹ã€‚ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰",
      "exercise": "ï¼ˆæ”¹å–„ã®ãŸã‚ã®å…·ä½“çš„ãªã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºãƒ»ç·´ç¿’æ–¹æ³•ã‚’60-80æ–‡å­—ã§èª¬æ˜ã€‚å®Ÿæ–½æ–¹æ³•ã€å›æ•°ã€é »åº¦ã‚’å«ã‚ã‚‹ã€‚ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰"
    }}
  ]
}}

è¦æ±‚äº‹é …:
- å„èª²é¡Œã«å¯¾ã—ã¦1ã¤ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ
- è§’åº¦ã®å•é¡Œï¼ˆå·¦ä¸‹è…¿è§’åº¦å¤§ãªã©ï¼‰ã§ã¯ã€ãƒã‚¤ã‚ªãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹çš„ãªå½±éŸ¿ã‚’èª¬æ˜
- èª¬æ˜éƒ¨åˆ†ã¯èµ°è¡ŒåŠ¹ç‡ã€æ€ªæˆ‘ãƒªã‚¹ã‚¯ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼æ¶ˆè²»ã¸ã®å½±éŸ¿ã‚’å«ã‚ã‚‹
- ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã¯åˆå¿ƒè€…ã§ã‚‚å®Ÿè·µã§ãã‚‹å…·ä½“çš„ãªæ–¹æ³•ã‚’æç¤º
- åŒ»å­¦çš„ãƒ»ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸå†…å®¹ã§
- ãƒã‚¸ãƒ†ã‚£ãƒ–ã§åŠ±ã¾ã—ã®è¦ç´ ã‚’å«ã‚ã‚‹
- ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ï¼ˆ#, *, -, **ãªã©ï¼‰ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„
- JSONå½¢å¼ä»¥å¤–ã¯ä¸€åˆ‡å‡ºåŠ›ã—ãªã„"""
    
    return prompt

@app.get("/")
async def health_check():
    """ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
    return {
        "status": "healthy", 
        "service": "advice_generation",
        "ai_provider": "Google Gemini",
        "version": "2.0.0"
    }

@app.post("/generate", response_model=AdviceResponse)
async def generate_advice(request: AdviceRequest):
    """
    Gemini APIã‚’ä½¿ç”¨ã—ã¦æ¤œå‡ºã•ã‚ŒãŸèª²é¡Œã«åŸºã¥ã„ã¦æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã™ã‚‹
    
    Args:
        request: å‹•ç”»IDã¨èª²é¡Œãƒªã‚¹ãƒˆ
        
    Returns:
        Gemini AIãŒç”Ÿæˆã—ãŸå…·ä½“çš„ãªæ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    """
    try:
        # ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å‡ºåŠ›
        print("=" * 80)
        print("ğŸš€ [GEMINI ADVICE SERVICE] ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡")
        print(f"   ğŸ“¹ å‹•ç”»ID: {request.video_id}")
        print(f"   ğŸ“ èª²é¡Œæ•°: {len(request.issues)}")
        
        # å …ç‰¢å‡¦ç†: èª²é¡Œãƒªã‚¹ãƒˆã®æ¤œè¨¼ã¨ä¿®æ­£
        valid_issues = [issue.strip() for issue in request.issues if issue and issue.strip()]
        
        if not valid_issues:
            print("   âš ï¸  æœ‰åŠ¹ãªèª²é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä¸€èˆ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚")
            valid_issues = ["ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ å…¨èˆ¬ã®æ”¹å–„"]
        
        print(f"   âœ… æœ‰åŠ¹ãªèª²é¡Œæ•°: {len(valid_issues)}")
        for i, issue in enumerate(valid_issues, 1):
            print(f"      {i}. {issue}")
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã®ç¢ºèª
        prompt_settings = request.prompt_settings
        if prompt_settings:
            if prompt_settings.get('use_custom_prompt', False):
                print(f"   âœï¸ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå—ä¿¡:")
                custom_prompt = prompt_settings.get('custom_prompt', '')
                print(f"      ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé•·: {len(custom_prompt)} æ–‡å­—")
                print(f"      Temperature: {prompt_settings.get('temperature', 0.7)}")
                print(f"      Top-P: {prompt_settings.get('top_p', 0.8)}")
                print(f"      Max Tokens: {prompt_settings.get('max_output_tokens', 1000)}")
                print(f"      ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ¦‚è¦: {custom_prompt[:100]}...")
            else:
                print(f"   ğŸ¯ ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šå—ä¿¡:")
                print(f"      ã‚³ãƒ¼ãƒãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: {prompt_settings.get('coaching_style', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ')}")
                print(f"      è©³ç´°ãƒ¬ãƒ™ãƒ«: {prompt_settings.get('advice_detail_level', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ')}")
                print(f"      ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºå«ã‚ã‚‹: {prompt_settings.get('include_exercises', True)}")
                print(f"      å°‚é–€ç”¨èªä½¿ç”¨: {prompt_settings.get('use_scientific_terms', False)}")
        else:
            print(f"   ğŸ“ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã‚’ä½¿ç”¨")
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        if prompt_settings and prompt_settings.get('use_custom_prompt', False):
            # ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨
            custom_template = prompt_settings.get('custom_prompt', '')
            issues_str = "ã€".join(valid_issues)
            prompt = custom_template.replace('{issues}', issues_str)
            print(f"   ğŸ“ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé©ç”¨æ¸ˆã¿ (é•·ã•: {len(prompt)} æ–‡å­—)")
        else:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨
            prompt = create_gemini_prompt(valid_issues)
        print(f"   ğŸ¤– Gemini APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...")
        
        # ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã«å¿œã˜ãŸãƒ¢ãƒ‡ãƒ«é¸æŠ
        current_model = model  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«
        if prompt_settings:
            # ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒã‚ã‚‹å ´åˆã€å‹•çš„ã«è¨­å®šã‚’é©ç”¨
            try:
                custom_config = genai.types.GenerationConfig(
                    temperature=prompt_settings.get('temperature', 0.7),
                    top_p=prompt_settings.get('top_p', 0.8),
                    max_output_tokens=prompt_settings.get('max_output_tokens', 1000),
                )
                
                current_model = genai.GenerativeModel(
                    'gemini-flash-latest',
                    generation_config=custom_config,
                    safety_settings=[
                        {'category': 'HARM_CATEGORY_HARASSMENT', 'threshold': 'BLOCK_NONE'},
                        {'category': 'HARM_CATEGORY_HATE_SPEECH', 'threshold': 'BLOCK_NONE'},
                        {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'threshold': 'BLOCK_NONE'},
                        {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'threshold': 'BLOCK_NONE'},
                    ]
                )
                print(f"   ğŸ›ï¸ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«è¨­å®šé©ç”¨æ¸ˆã¿")
            except Exception as e:
                print(f"   âš ï¸ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚¨ãƒ©ãƒ¼ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½¿ç”¨: {e}")

        # Gemini APIã®å‘¼ã³å‡ºã—ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œï¼‰
        max_retries = 3
        response = None
        for attempt in range(max_retries):
            try:
                response = current_model.generate_content(prompt)
                ai_response = response.text.strip()
                break
            except Exception as api_error:
                if "429" in str(api_error) or "quota" in str(api_error).lower():
                    if attempt < max_retries - 1:
                        wait_time = (attempt + 1) * 5  # 5ç§’, 10ç§’, 15ç§’ã®é–“éš”
                        print(f"   â³ ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ¤œå‡ºã€{wait_time}ç§’å¾…æ©Ÿå¾Œã«ãƒªãƒˆãƒ©ã‚¤ ({attempt + 1}/{max_retries})")
                        time.sleep(wait_time)
                        continue
                    else:
                        print(f"   âŒ æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚")
                        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’é–‹å§‹
                        ai_response = ""
                        break
                else:
                    raise api_error
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
        if not response:
            ai_response = ""
        elif response.candidates:
            candidate = response.candidates[0]
            if candidate.finish_reason == 2:  # SAFETY
                print(f"   âš ï¸  çµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒå®‰å…¨æ€§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ")
                ai_response = "ä»Šå›ã®åˆ†æçµæœã‚’å‚è€ƒã«ã€åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚"
            elif hasattr(response, 'text') and response.text:
                ai_response = response.text.strip()
            else:
                ai_response = ""
        elif hasattr(response, 'text') and response.text:
            ai_response = response.text.strip()
        else:
            ai_response = ""
        
        print(f"   ğŸ“¨ Geminiå¿œç­”å—ä¿¡ (é•·ã•: {len(ai_response)} æ–‡å­—)")
        print(f"   ğŸ“„ ç”Ÿã®å¿œç­”: {ai_response[:200]}...")
        
        # JSONè§£æ
        try:
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONéƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãªã©ã‚’é™¤å»ï¼‰
            if "```json" in ai_response:
                json_start = ai_response.find("```json") + 7
                json_end = ai_response.find("```", json_start)
                ai_response = ai_response[json_start:json_end].strip()
            elif "```" in ai_response:
                json_start = ai_response.find("```") + 3
                json_end = ai_response.rfind("```")
                ai_response = ai_response[json_start:json_end].strip()
            
            ai_data = json.loads(ai_response)
            
            if "advices" not in ai_data:
                raise ValueError("å¿œç­”ã«advicesã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“")
            
            # ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã®å¤‰æ›
            advice_list = []
            for advice in ai_data["advices"]:
                advice_item = {
                    "issue": valid_issues[len(advice_list)] if len(advice_list) < len(valid_issues) else "ãã®ä»–ã®æ”¹å–„ç‚¹",
                    "title": advice.get("title", "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„"),
                    "description": advice.get("description", "ç¶™ç¶šçš„ãªç·´ç¿’ã§æ”¹å–„ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚"),
                    "exercise": advice.get("exercise", "æ—¥ã€…ã®ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã§æ„è­˜ã—ã¦ç·´ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚")
                }
                advice_list.append(advice_item)
            
            print(f"   âœ¨ {len(advice_list)}ã¤ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
            for i, advice in enumerate(advice_list, 1):
                print(f"      {i}. {advice['title']}")
        
        except json.JSONDecodeError as e:
            print(f"   âŒ JSONè§£æã‚¨ãƒ©ãƒ¼: {str(e)}")
            print(f"   ğŸ“„ å•é¡Œã®ã‚ã‚‹å¿œç­”: {ai_response}")
            
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é™çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
            advice_list = []
            for issue in valid_issues:
                advice_item = {
                    "issue": issue,
                    "title": "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„",
                    "description": f"æ¤œå‡ºã•ã‚ŒãŸèª²é¡Œã€Œ{issue}ã€ã«ã¤ã„ã¦ã€ç¶™ç¶šçš„ãªç·´ç¿’ã¨æ„è­˜æ”¹é©ã§æ”¹å–„ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ã§ã€ã‚ˆã‚ŠåŠ¹ç‡çš„ã§æ€ªæˆ‘ã®ãƒªã‚¹ã‚¯ãŒå°‘ãªã„ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚",
                    "exercise": "ç·´ç¿’ãƒ‰ãƒªãƒ«: æ¯å›ã®ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°å‰ã«ãƒ•ã‚©ãƒ¼ãƒ ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€æ„è­˜çš„ã«æ”¹å–„ãƒã‚¤ãƒ³ãƒˆã‚’ç·´ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚é¡ã®å‰ã§å‹•ãã‚’ç¢ºèªã—ãŸã‚Šã€ä»²é–“ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‚ã‚‰ã†ã“ã¨ã‚‚åŠ¹æœçš„ã§ã™ã€‚"
                }
                advice_list.append(advice_item)
            
            print(f"   ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§{len(advice_list)}ã¤ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ")
        
        # å …ç‰¢å‡¦ç†: ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒãªã„å ´åˆã®å¯¾å¿œ
        if not advice_list:
            advice_list = [{
                "issue": "ä¸€èˆ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹",
                "title": "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ å‘ä¸Š",
                "description": "ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’åŸºã«ã€ç¶™ç¶šçš„ãªæ”¹å–„ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚å®šæœŸçš„ãªãƒ•ã‚©ãƒ¼ãƒ ãƒã‚§ãƒƒã‚¯ã¨æ„è­˜çš„ãªç·´ç¿’ãŒä¸Šé”ã®éµã§ã™ã€‚",
                "exercise": "ç·´ç¿’ãƒ‰ãƒªãƒ«: é€±ã«1å›ã€è‡ªåˆ†ã®ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°å‹•ç”»ã‚’æ’®å½±ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚"
            }]
        
        print(f"   ğŸ“Š æœ€çµ‚çš„ã«{len(advice_list)}ã¤ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿”å´")
        print("=" * 80)
        
        return AdviceResponse(
            status="success",
            message=f"Gemini AIãŒ{len(advice_list)}ã¤ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¾ã—ãŸ",
            advice_list=advice_list
        )
        
    except Exception as e:
        print(f"âŒ [GEMINI ADVICE SERVICE] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {str(e)}")
        print(f"   ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: {type(e).__name__}")
        
        # ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        try:
            fallback_advice = [{
                "issue": "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼",
                "title": "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ç¶™ç¶šã‚µãƒãƒ¼ãƒˆ",
                "description": "ã‚·ã‚¹ãƒ†ãƒ ã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã‚ãªãŸã®ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã®å‘ä¸Šã¸ã®å–ã‚Šçµ„ã¿ã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ æ„è­˜ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚",
                "exercise": "ç·´ç¿’ãƒ‰ãƒªãƒ«: ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸå§¿å‹¢ã§ã€è‡ªç„¶ãªãƒªã‚ºãƒ ã‚’ä¿ã¡ãªãŒã‚‰ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚"
            }]
            
            return AdviceResponse(
                status="success",
                message="ä¸€æ™‚çš„ãªã‚·ã‚¹ãƒ†ãƒ å•é¡Œã«ã‚ˆã‚Šã€åŸºæœ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ã„ã¾ã™",
                advice_list=fallback_advice
            )
        except:
            raise HTTPException(
                status_code=500, 
                detail=f"ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
            )

@app.get("/model/info")
async def get_model_info():
    """ä½¿ç”¨ã—ã¦ã„ã‚‹AIãƒ¢ãƒ‡ãƒ«ã®æƒ…å ±ã‚’å–å¾—"""
    return {
        "ai_provider": "Google Gemini",
        "model": "gemini-flash-latest",
        "version": "2.0.0",
        "features": [
            "è‡ªç„¶è¨€èªã«ã‚ˆã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ",
            "èª²é¡Œã«å¿œã˜ãŸå€‹åˆ¥å¯¾å¿œ",
            "å®Ÿè·µçš„ãªã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºææ¡ˆ",
            "ãƒã‚¸ãƒ†ã‚£ãƒ–ã§å»ºè¨­çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯"
        ]
    }

@app.get("/exercises/categories")
async def get_exercise_categories():
    """ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã‚«ãƒ†ã‚´ãƒªã¨åŠ¹æœã‚’å–å¾—ï¼ˆå¾“æ¥äº’æ›æ€§ã®ãŸã‚æ®‹å­˜ï¼‰"""
    return {
        "strength": {
            "description": "ç­‹åŠ›å¼·åŒ–ã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒ å®‰å®šåŒ–",
            "target_issues": ["éå¯¾ç§°æ€§", "å®‰å®šæ€§ä¸è¶³", "æ¨é€²åŠ›ä¸è¶³"],
            "example_exercises": ["ã‚·ãƒ³ã‚°ãƒ«ãƒ¬ãƒƒã‚°ãƒ»ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ", "ãƒ’ãƒƒãƒ—ãƒ–ãƒªãƒƒã‚¸", "ãƒ—ãƒ©ãƒ³ã‚¯"]
        },
        "flexibility": {
            "description": "æŸ”è»Ÿæ€§æ”¹å–„ã«ã‚ˆã‚‹å¯å‹•åŸŸæ‹¡å¤§",
            "target_issues": ["ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰åˆ¶é™", "å§¿å‹¢å•é¡Œ", "ç­‹è‚‰ã®ç¡¬ã•"],
            "example_exercises": ["ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚¹ãƒˆãƒ¬ãƒƒãƒ", "ãƒ’ãƒƒãƒ—ãƒ•ãƒ¬ã‚¯ã‚µãƒ¼ã‚¹ãƒˆãƒ¬ãƒƒãƒ", "ã‚«ãƒ¼ãƒ•ã‚¹ãƒˆãƒ¬ãƒƒãƒ"]
        },
        "technique": {
            "description": "å‹•ä½œãƒ‘ã‚¿ãƒ¼ãƒ³ã®æŠ€è¡“çš„æ”¹å–„",
            "target_issues": ["ã‚ªãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰", "ç€åœ°ãƒ‘ã‚¿ãƒ¼ãƒ³", "è…•æŒ¯ã‚Š"],
            "example_exercises": ["ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ãƒ‰ãƒªãƒ«", "ãƒã‚¤ãƒ‹ãƒ¼", "ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°"]
        },
        "cardio": {
            "description": "å¿ƒè‚ºæ©Ÿèƒ½ã¨ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°æŒä¹…åŠ›ã®å‘ä¸Š",
            "target_issues": ["åŠ¹ç‡æ€§", "ç–²åŠ´ã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒ å´©ã‚Œ"],
            "example_exercises": ["ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«èµ°", "ãƒ†ãƒ³ãƒèµ°", "LSD"]
        }
    }

@app.post("/generate-advanced", response_model=AdvancedAdviceResponse)
async def generate_advanced_advice_endpoint(request: AdvancedAdviceRequest):
    """
    ãƒ—ãƒ­ã®ã‚³ãƒ¼ãƒãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã™ã‚‹
    
    Args:
        request: å‹•ç”»IDã¨èª²é¡Œãƒªã‚¹ãƒˆ
        
    Returns:
        è¤‡æ•°ã®èª²é¡Œã‚’çµ„ã¿åˆã‚ã›ãŸæ§‹é€ åŒ–ã•ã‚ŒãŸé«˜ãƒ¬ãƒ™ãƒ«ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    """
    try:
        # ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å‡ºåŠ›
        print("=" * 80)
        print("ğŸ¯ [ADVANCED ADVICE SERVICE] é«˜ãƒ¬ãƒ™ãƒ«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡")
        print(f"   ğŸ“¹ å‹•ç”»ID: {request.video_id}")
        print(f"   ğŸ“ èª²é¡Œæ•°: {len(request.issues_list)}")
        
        # èª²é¡Œãƒªã‚¹ãƒˆã®æ¤œè¨¼ã¨å‰å‡¦ç†
        valid_issues = [issue.strip() for issue in request.issues_list if issue and issue.strip()]
        
        print(f"   âœ… æœ‰åŠ¹ãªèª²é¡Œæ•°: {len(valid_issues)}")
        for i, issue in enumerate(valid_issues, 1):
            print(f"      {i}. {issue}")
        
        # é«˜ãƒ¬ãƒ™ãƒ«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        print(f"   ğŸ§  é«˜ãƒ¬ãƒ™ãƒ«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆä¸­...")
        advanced_advice = generate_advanced_advice(valid_issues)
        
        print(f"   ğŸ“¨ é«˜ãƒ¬ãƒ™ãƒ«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆå®Œäº† (é•·ã•: {len(advanced_advice)} æ–‡å­—)")
        print(f"   ğŸ“„ ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ¦‚è¦: {advanced_advice[:100]}...")
        print("=" * 80)
        
        return AdvancedAdviceResponse(
            status="success",
            message=f"ãƒ—ãƒ­ãƒ¬ãƒ™ãƒ«ã®æ§‹é€ åŒ–ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¾ã—ãŸ",
            video_id=request.video_id,
            advice=advanced_advice
        )
        
    except Exception as e:
        print(f"âŒ [ADVANCED ADVICE SERVICE] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {str(e)}")
        print(f"   ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: {type(e).__name__}")
        
        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒ‰ãƒã‚¤ã‚¹
        try:
            fallback_advice = generate_advanced_advice([])  # ä¸€èˆ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ
            
            return AdvancedAdviceResponse(
                status="success",
                message="ã‚·ã‚¹ãƒ†ãƒ å•é¡Œã«ã‚ˆã‚Šä¸€èˆ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ã„ã¾ã™",
                video_id=request.video_id,
                advice=fallback_advice
            )
        except:
            raise HTTPException(
                status_code=500, 
                       detail=f"é«˜ãƒ¬ãƒ™ãƒ«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
                   )

@app.post("/generate-integrated", response_model=IntegratedAdviceResponse)
async def generate_integrated_advice_endpoint(request: IntegratedAdviceRequest):
    """
    ãƒ—ãƒ­ã‚³ãƒ¼ãƒã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã¨Gemini AIè©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’çµ±åˆã™ã‚‹
    
    Args:
        request: å‹•ç”»IDã¨èª²é¡Œãƒªã‚¹ãƒˆ
        
    Returns:
        ãƒ—ãƒ­ã‚³ãƒ¼ãƒï¼‹AIçµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹
    """
    try:
        print("=" * 80)
        print("ğŸ¯ [INTEGRATED ADVICE SERVICE] çµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡")
        print(f"   ğŸ“¹ å‹•ç”»ID: {request.video_id}")
        print(f"   ğŸ“ èª²é¡Œæ•°: {len(request.issues_list)}")
        
        valid_issues = [issue.strip() for issue in request.issues_list if issue and issue.strip()]
        
        print(f"   âœ… æœ‰åŠ¹ãªèª²é¡Œæ•°: {len(valid_issues)}")
        for i, issue in enumerate(valid_issues, 1):
            print(f"      {i}. {issue}")
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã®ç¢ºèª
        prompt_settings = request.prompt_settings
        if prompt_settings:
            print(f"   ğŸ¯ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šå—ä¿¡:")
            print(f"      ã‚³ãƒ¼ãƒãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: {prompt_settings.get('coaching_style', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ')}")
            print(f"      è©³ç´°ãƒ¬ãƒ™ãƒ«: {prompt_settings.get('advice_detail_level', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ')}")
            print(f"      ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºå«ã‚ã‚‹: {prompt_settings.get('include_exercises', True)}")
            print(f"      å°‚é–€ç”¨èªä½¿ç”¨: {prompt_settings.get('use_scientific_terms', False)}")
        else:
            print(f"   ğŸ“ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã‚’ä½¿ç”¨")
        
        print(f"   ğŸ§  çµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆä¸­...")
        integrated_advice = await generate_integrated_advice(valid_issues)
        
        print(f"   ğŸ“¨ çµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆå®Œäº† (é•·ã•: {len(integrated_advice)} æ–‡å­—)")
        print(f"   ğŸ“„ ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ¦‚è¦: {integrated_advice[:100]}...")
        print("=" * 80)
        
        return IntegratedAdviceResponse(
            status="success",
            message=f"ãƒ—ãƒ­ã‚³ãƒ¼ãƒï¼‹AIçµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¾ã—ãŸ",
            video_id=request.video_id,
            integrated_advice=integrated_advice
        )
        
    except Exception as e:
        print(f"âŒ [INTEGRATED ADVICE SERVICE] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {str(e)}")
        print(f"   ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: {type(e).__name__}")
        
        try:
            fallback_advice = generate_advanced_advice([])
            
            return IntegratedAdviceResponse(
                status="success",
                message="ã‚·ã‚¹ãƒ†ãƒ å•é¡Œã«ã‚ˆã‚ŠåŸºæœ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ã„ã¾ã™",
                video_id=request.video_id,
                integrated_advice=fallback_advice
            )
        except:
            raise HTTPException(
                status_code=500, 
                detail=f"çµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
            )

if __name__ == "__main__":
    print("ğŸš€ Gemini-Powered Advice Generation Service ã‚’èµ·å‹•ä¸­...")
    print(f"ğŸ”‘ API Key: {'è¨­å®šæ¸ˆã¿' if GEMINI_API_KEY else 'æœªè¨­å®š'}")
    uvicorn.run(app, host="0.0.0.0", port=8005) 