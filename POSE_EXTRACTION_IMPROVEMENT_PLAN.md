# 骨格抽出精度改善プラン

## 現状の問題

### 症状
- **ローカル環境**: 骨格が表示されるが、動きが不自然
- **EC2環境**: 骨格が縦一直線や変な動きになる
- **共通問題**: 両環境とも骨格抽出の精度が低い

### 根本原因の仮説
1. **前処理の過剰適用**: 複数のフィルター（ガウシアンブラー、バイラテラル、CLAHE、シャープ化）が連続適用され、かえって精度を下げている可能性
2. **スムージングの強度**: 過去5フレームの移動平均（alpha=0.6）が強すぎて、実際の動きを滑らかにしすぎている
3. **MediaPipe設定の最適化不足**: 検出閾値は低いが、他のパラメータが最適化されていない
4. **キーポイント補間の不足**: 検出失敗時の補間ロジックが不十分
5. **動画品質への対応不足**: 解像度、フレームレート、照明条件の違いに対応できていない

---

## 解決策とインパクト評価

### 【解決策1】前処理の最適化と簡素化
**内容:**
- 過剰な前処理を削減（ガウシアンブラーとバイラテラルフィルターの併用をやめる）
- CLAHEのパラメータ調整（clipLimit、tileGridSize）
- シャープ化の強度調整
- 前処理の順序最適化

**インパクト:**
- **期待効果**: 中〜高（精度向上の可能性が高い）
- **実装難易度**: 低（パラメータ調整のみ）
- **リスク**: 低（既存の処理を調整するだけ）

**実装時間**: 1-2時間

---

### 【解決策2】スムージングアルゴリズムの改善
**内容:**
- 現在の移動平均（alpha=0.6）から、より適応的なスムージングに変更
- カルマンフィルターや補間ベースのスムージングを検討
- フレーム間の距離が大きい場合はスムージングを弱める
- 可視性が低いキーポイントの補間を改善

**インパクト:**
- **期待効果**: 高（動きの自然さが大幅に改善される可能性）
- **実装難易度**: 中（アルゴリズムの実装が必要）
- **リスク**: 中（既存のスムージングロジックを変更）

**実装時間**: 3-4時間

---

### 【解決策3】MediaPipe設定の詳細最適化
**内容:**
- `static_image_mode=False` の確認（動画モード）
- `smooth_landmarks=True` の追加（MediaPipeの内部スムージング）
- `smooth_segmentation=False` の確認
- 解像度に応じた最適化（小さい動画はアップスケール、大きい動画はダウンスケール）

**インパクト:**
- **期待効果**: 中（MediaPipeの内部最適化を活用）
- **実装難易度**: 低（パラメータ追加のみ）
- **リスク**: 低（既存設定の拡張）

**実装時間**: 30分-1時間

---

### 【解決策4】キーポイント補間・予測の強化
**内容:**
- 検出失敗時の前フレームからの補間
- 物理的制約（骨の長さ、関節角度の範囲）を考慮した補正
- 異常値検出と修正（他のキーポイントとの関係から異常を検出）

**インパクト:**
- **期待効果**: 高（検出失敗時の品質が大幅に改善）
- **実装難易度**: 高（複雑なロジックが必要）
- **リスク**: 中（誤補正の可能性）

**実装時間**: 4-6時間

---

### 【解決策5】動画品質の事前チェックと最適化
**内容:**
- 動画の解像度、フレームレート、明るさを事前にチェック
- 品質が低い場合は警告を表示
- 解像度が低い場合はアップスケール、高すぎる場合はダウンスケール
- 明るさが低い場合は自動補正

**インパクト:**
- **期待効果**: 中（品質の低い動画でも精度向上）
- **実装難易度**: 中（動画解析と前処理の追加）
- **リスク**: 低（既存処理の拡張）

**実装時間**: 2-3時間

---

### 【解決策6】複数フレームの統合検出
**内容:**
- 単一フレームではなく、複数フレーム（例：3-5フレーム）を統合して検出
- 時系列的な一貫性を考慮した検出
- 検出結果の投票方式（複数フレームで検出された位置の平均）

**インパクト:**
- **期待効果**: 高（検出の安定性と精度が大幅に向上）
- **実装難易度**: 高（複数フレームの処理と統合ロジックが必要）
- **リスク**: 中（処理時間の増加）

**実装時間**: 5-8時間

---

### 【解決策7】MediaPipeの代替/補完検討
**内容:**
- YOLO PoseやOpenPoseなどの他のポーズ推定ライブラリを検討
- MediaPipeと他のライブラリの結果を統合（アンサンブル）
- より高精度なモデル（例：MediaPipeの最新版、カスタムモデル）の検討

**インパクト:**
- **期待効果**: 非常に高（根本的な精度向上の可能性）
- **実装難易度**: 非常に高（新しいライブラリの統合、モデルの学習）
- **リスク**: 高（大幅な変更が必要、互換性の問題）

**実装時間**: 1-2週間

---

## 推奨実装順序

### Phase 1: 即効性のある改善（1-2日）
1. **解決策1**: 前処理の最適化と簡素化
2. **解決策3**: MediaPipe設定の詳細最適化
3. **解決策5**: 動画品質の事前チェックと最適化

**期待インパクト**: 中〜高
**総実装時間**: 4-6時間

### Phase 2: アルゴリズム改善（3-5日）
4. **解決策2**: スムージングアルゴリズムの改善
5. **解決策4**: キーポイント補間・予測の強化

**期待インパクト**: 高
**総実装時間**: 7-10時間

### Phase 3: 高度な改善（1-2週間）
6. **解決策6**: 複数フレームの統合検出
7. **解決策7**: MediaPipeの代替/補完検討（必要に応じて）

**期待インパクト**: 非常に高
**総実装時間**: 1-2週間

---

## 各解決策の詳細

### 解決策1: 前処理の最適化と簡素化

**現在の問題:**
```python
# 現在の前処理（連続適用）
1. 解像度アップスケール
2. ガウシアンブラー (3, 3)
3. バイラテラルフィルター (5, 50, 50)
4. CLAHE (clipLimit=3.0, tileGridSize=(8, 8))
5. シャープ化 (kernel * 0.15 + eye * 0.55)
```

**改善案:**
```python
# 最適化された前処理
1. 解像度最適化（640px以上にアップスケール、1920px以上はダウンスケール）
2. ノイズ除去（ガウシアンブラー OR バイラテラル、併用しない）
3. コントラスト調整（CLAHE、clipLimitを動的に調整）
4. シャープ化（必要に応じて、強度を調整）
```

**期待される改善:**
- 過剰な前処理による精度低下を防止
- 処理速度の向上
- より自然な骨格抽出

---

### 解決策2: スムージングアルゴリズムの改善

**現在の問題:**
- 固定の移動平均（alpha=0.6）を使用
- すべてのキーポイントに同じスムージングを適用
- フレーム間の距離を考慮していない

**改善案:**
```python
# 適応的スムージング
- 可視性に応じたスムージング強度（可視性が低い場合は強め）
- フレーム間距離が大きい場合はスムージングを弱める
- 物理的制約を考慮（骨の長さ、関節角度の範囲）
```

**期待される改善:**
- より自然な動きの表現
- 検出失敗時の補間品質向上
- 急激な動きの正確な追跡

---

### 解決策3: MediaPipe設定の詳細最適化

**追加すべき設定:**
```python
mp_pose.Pose(
    static_image_mode=False,
    model_complexity=2,
    enable_segmentation=False,
    smooth_landmarks=True,  # 追加：MediaPipeの内部スムージング
    min_detection_confidence=0.1,
    min_tracking_confidence=0.1,
    refine_face_landmarks=False  # 顔のランドマークは不要
)
```

**期待される改善:**
- MediaPipeの内部最適化を活用
- より滑らかな検出結果

---

### 解決策4: キーポイント補間・予測の強化

**実装内容:**
1. **前フレーム補間**: 検出失敗時は前フレームの位置を使用
2. **物理的制約**: 
   - 骨の長さが急激に変化しない
   - 関節角度が物理的に可能な範囲内
3. **異常値検出**: 
   - 他のキーポイントとの関係から異常を検出
   - 例：肩と肘の距離が異常に長い場合は補正

**期待される改善:**
- 検出失敗時の品質向上
- より一貫性のある骨格表示

---

### 解決策5: 動画品質の事前チェックと最適化

**実装内容:**
```python
# 動画品質チェック
- 解像度: 640x480未満は警告、1920x1080以上はダウンスケール
- フレームレート: 15fps未満は警告
- 明るさ: 平均輝度が低い場合は自動補正
- コントラスト: 低コントラストの場合は警告
```

**期待される改善:**
- 品質の低い動画でも精度向上
- ユーザーへのフィードバック提供

---

### 解決策6: 複数フレームの統合検出

**実装内容:**
```python
# 3-5フレームの統合検出
1. 現在フレームと前後2フレームを取得
2. 各フレームでMediaPipe検出を実行
3. 検出結果を統合（投票方式、重み付き平均）
4. 時系列的な一貫性を考慮
```

**期待される改善:**
- 検出の安定性と精度が大幅に向上
- ノイズの影響を軽減

**注意点:**
- 処理時間が3-5倍に増加
- メモリ使用量の増加

---

### 解決策7: MediaPipeの代替/補完検討

**検討すべきライブラリ:**
1. **YOLO Pose**: より高精度だが処理が重い
2. **OpenPose**: 高精度だが実装が複雑
3. **MediaPipe最新版**: バージョンアップによる精度向上
4. **カスタムモデル**: ランニング専用のモデル学習

**期待される改善:**
- 根本的な精度向上の可能性
- ランニング動作に特化した検出

**注意点:**
- 大幅な変更が必要
- 互換性の問題
- 処理時間の増加の可能性

---

## 総合評価

### 最も効果的な組み合わせ（推奨）

**短期（1-2日）:**
- 解決策1 + 解決策3 + 解決策5
- **期待インパクト**: 中〜高
- **実装時間**: 4-6時間
- **リスク**: 低

**中期（1週間）:**
- 上記 + 解決策2 + 解決策4
- **期待インパクト**: 高
- **実装時間**: 11-16時間
- **リスク**: 中

**長期（2週間以上）:**
- 上記 + 解決策6
- **期待インパクト**: 非常に高
- **実装時間**: 16-24時間
- **リスク**: 中〜高

---

## 実装前の確認事項

1. **動画の品質**: 実際に使用されている動画の解像度、フレームレート、明るさを確認
2. **MediaPipeのバージョン**: 最新版（0.10.7）を使用しているか確認
3. **処理時間**: 現在の処理時間を測定し、改善後の処理時間との比較
4. **テストデータ**: 複数の動画でテストし、改善効果を測定

---

## 次のステップ

1. **Phase 1の実装**: 即効性のある改善から開始
2. **効果測定**: 改善前後の比較（骨格の表示品質、検出精度）
3. **段階的改善**: 効果が確認できたらPhase 2、Phase 3へ進む
