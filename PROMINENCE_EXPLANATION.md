# Prominence（突出度）とは？- 接地・離地検出の仕組み

## 📊 Prominence（突出度）の概念

### 定義

**Prominence（突出度）** = ピークの「目立ち度」を表す指標

ピークが周囲の谷からどれだけ高く突き出ているかを測定します。

---

## 🎨 視覚的な説明

### 例1: 高いProminence（目立つピーク）

```
       /\              ← 高いピーク
      /  \
     /    \
    /      \___        ← 深い谷
___/           \___

Prominence = 高い（検出される）
```

### 例2: 低いProminence（目立たないピーク）

```
   /\                 ← 低いピーク
__/  \__              ← 浅い谷

Prominence = 低い（検出されない可能性）
```

---

## 🔍 現在の接地・離地検出条件

### ステップ1: データの平滑化

```python
# ガウシアンフィルタで足首Y座標のノイズを除去
sigma = max(1.0, video_fps * 0.03)  # 0.03秒相当
smoothed_y = ndimage.gaussian_filter1d(y_array, sigma=sigma)
```

**目的**: ノイズ（手ブレ等）を除去し、真のピークを見つけやすくする

---

### ステップ2: 接地（strike）の検出

#### パラメータ

```python
# 接地検出（極小値 = 足首が最も下）
inverted_y = -smoothed_y  # Y座標を反転して極大値として検出

strike_peaks, strike_properties = find_peaks(
    inverted_y,
    distance=max(3, int(video_fps * 0.15)),  # 最小間隔0.15秒
    height=np.percentile(inverted_y, 50),    # 上位50%の極値
    prominence=0.002                          # 突出度0.002以上
)
```

#### 各パラメータの意味

| パラメータ | 現在の値 | 意味 | 厳しさ |
|-----------|---------|------|--------|
| **distance** | `0.15秒` | 2つのピーク間の最小間隔 | 緩い（短い間隔でもOK） |
| **height** | `50パーセンタイル` | ピークの高さの最低値 | 緩い（中央値以上ならOK） |
| **prominence** | `0.002` | ピークの突出度の最低値 | 緩い（かなり小さい値） |

#### 検出例

```
足首Y座標（反転後）:

    ↑
    │     /\           /\
    │    /  \         /  \      ← 接地のピーク
    │___/____\_______/____\___
    │
    └─────────────────────────→ 時間

両方のピークが検出される（prominence >= 0.002）
```

---

### ステップ3: 離地（off）の検出

#### パラメータ

```python
# 離地検出（極大値 = 足首が最も上）
off_peaks, off_properties = find_peaks(
    smoothed_y,  # 反転なし
    distance=max(3, int(video_fps * 0.15)),  # 最小間隔0.15秒
    height=np.percentile(smoothed_y, 50),    # 上位50%の極値
    prominence=0.002                          # 突出度0.002以上
)
```

#### 検出例（離地が難しい場合）

```
足首Y座標:

    ↑
    │   ～～～              ← 離地のピーク（緩やか）
    │  /     \
    │ /       \___
    │/           
    └─────────────────────────→ 時間

prominence < 0.002 → 検出されない！
```

---

## ⚖️ 現在の設定は「緩い」

### 以前の設定（バックアップファイル）との比較

| パラメータ | 以前の値 | 現在の値 | 変更 |
|-----------|---------|---------|------|
| **distance** | `0.2秒` | `0.15秒` | ✅ 緩和（より多くのピークを検出） |
| **height** | `70パーセンタイル` | `50パーセンタイル` | ✅ 緩和（より低いピークも検出） |
| **prominence** | `0.005` | `0.002` | ✅ 緩和（より目立たないピークも検出） |

**結論**: 現在の設定は**かなり寛容**で、できるだけ多くのイベントを検出しようとしています。

---

## 🎯 Prominence = 0.002 の意味

### 具体例

30fps、解像度1080pの動画の場合：

```python
# Y座標は0.0～1.0の範囲（正規化座標）
prominence = 0.002

# 実際のピクセル換算
0.002 × 1080px = 2.16px

# つまり、約2ピクセル以上突出していればOK
```

**非常に小さい値** = ほとんどのピークを検出

---

## 📊 検出の流れ（まとめ）

### 1. 前処理

```
生のY座標
    ↓
ガウシアンフィルタ（平滑化）
    ↓
ノイズ除去済みY座標
```

### 2. 接地検出

```
ノイズ除去済みY座標
    ↓
Y座標を反転（極小値を極大値に）
    ↓
find_peaks（distance, height, prominence）
    ↓
接地フレームのリスト
```

### 3. 離地検出

```
ノイズ除去済みY座標
    ↓
そのまま使用（極大値を検出）
    ↓
find_peaks（distance, height, prominence）
    ↓
離地フレームのリスト
```

### 4. 統合・検証

```
接地フレーム + 離地フレーム
    ↓
時系列でソート
    ↓
論理的な順序チェック（接地→離地→接地...）
    ↓
最終的なイベントリスト
```

---

## ❓ なぜ離地が検出されにくいのか？

### 理由1: ピークの形状

```
【接地】
    ↓ 鋭いピーク
   /|\
__/ | \__

prominence: 大きい ✅


【離地】
   ～～～  ← 緩やかなピーク
  /     \
_/       \_

prominence: 小さい ❌
```

### 理由2: ランニングフォームの影響

```
【高い足上げ（離地が明確）】
    /\
   /  \___

prominence: 大きい ✅


【フラット走法（離地が不明確）】
   ～～～
__/    \___

prominence: 小さい ❌
```

### 理由3: 撮影角度

```
【真横から】
足の上下動が明確
    /\
___/  \___

prominence: 大きい ✅


【斜めから】
足の上下動が圧縮
   ～～
___  ___

prominence: 小さい ❌
```

---

## 🛠️ 改善方法

### 方法1: Prominenceをさらに緩和（最終手段）

```python
prominence=0.001  # 現在の0.002から半分に
```

**リスク**: ノイズを誤検出する可能性

---

### 方法2: 離地のみ別の閾値を使用

```python
# 接地
strike_peaks = find_peaks(inverted_y, prominence=0.002)

# 離地（より緩い閾値）
off_peaks = find_peaks(smoothed_y, prominence=0.001)
```

**メリット**: 接地は厳密に、離地は寛容に

---

### 方法3: 動画撮影条件を改善（推奨）

✅ **真横から撮影**（±15度以内）
✅ **高さ1-1.5mから撮影**（足の動きが見やすい）
✅ **動画の長さを5秒以上に**（複数のサイクルを含む）
✅ **ランナーを画面中央に配置**
✅ **明るい環境で撮影**

---

## 📈 検出状況の確認方法

### ブラウザコンソールで確認

動画アップロード時、バックエンドのログがコンソールに表示されます：

```
🦶 足接地・離地検出を開始します...
   📊 データフレーム数: 150
   📊 左足 Y座標範囲: 0.650 - 0.850
   🔧 左足 平滑化後Y座標範囲: 0.652 - 0.848
   🦶 左足 find_peaks検出: 接地3回, 離地2回  ← ここを確認！
   🦶 右足 find_peaks検出: 接地3回, 離地3回
   📊 統合イベント数: 12
```

**確認ポイント**:
- 接地と離地が同じくらいの回数か？
- 離地が0回や極端に少ない場合は検出失敗

---

## 🎓 まとめ

### Prominence（突出度）とは

- ピークが周囲からどれだけ突出しているかを表す指標
- 値が大きい = 目立つピーク、検出されやすい
- 値が小さい = 目立たないピーク、検出されにくい

### 現在の検出条件

| 項目 | 接地（strike） | 離地（off） |
|------|--------------|------------|
| **検出対象** | 極小値（足首が最も下） | 極大値（足首が最も上） |
| **distance** | 0.15秒 | 0.15秒 |
| **height** | 50パーセンタイル | 50パーセンタイル |
| **prominence** | 0.002 | 0.002 |
| **厳しさ** | 緩い | 緩い |

### 離地が検出されにくい理由

1. ピークが緩やか（prominence < 0.002）
2. ランニングフォーム（フラット走法等）
3. 撮影角度（斜めから撮影）

### 推奨される対策

1. **動画撮影条件を改善**（最も効果的）
   - 真横から撮影
   - 5秒以上の動画
   - 明るい環境

2. **パラメータ調整**（必要に応じて）
   - 離地のprominenceを緩和（0.001等）

---

**作成日**: 2025年10月21日  
**対象ファイル**: `backend/services/analysis/app/main.py`  
**関連ドキュメント**: `VIDEO_REQUIREMENTS_FOR_ZSCORE_ANALYSIS.md`

