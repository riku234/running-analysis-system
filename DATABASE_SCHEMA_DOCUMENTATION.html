<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データベーススキーマ仕様書 - Running Analysis System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.8;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        h3 {
            color: #555;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
        }
        th {
            background-color: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        pre code {
            background-color: transparent;
            color: #ecf0f1;
        }
        ul, ol {
            margin-left: 20px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ecf0f1;
            margin: 30px 0;
        }
        .update-info {
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .version-badge {
            display: inline-block;
            background-color: #27ae60;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="update-info">
            <p><strong>📅 最終更新:</strong> 2025年10月6日 <span class="version-badge">v1.1</span></p>
            <p><strong>🔄 変更内容:</strong> データベースエンドポイント変更（cluster → single）、実測値追加</p>
        </div>
        <h1>データベーススキーマ仕様書</h1>
<h2>概要</h2>
<p>このドキュメントは、Running Analysis System（ランニング解析システム）のデータベース構造とデータ格納仕様を説明します。</p>
<hr />
<h2>データベース情報</h2>
<ul>
<li><strong>データベース名</strong>: <code>postgres</code></li>
<li><strong>DBMS</strong>: PostgreSQL 17.4</li>
<li><strong>ホスト</strong>: AWS RDS (running-analysis-db-single.cbqqcwic00jv.ap-southeast-2.rds.amazonaws.com)</li>
<li><strong>インスタンスタイプ</strong>: Single Instance</li>
<li><strong>文字エンコーディング</strong>: UTF-8</li>
<li><strong>最終更新日</strong>: 2025-10-06</li>
</ul>
<hr />
<h2>テーブル一覧</h2>
<table>
<thead>
<tr>
<th>テーブル名</th>
<th>説明</th>
<th>主な用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>users</code></td>
<td>ユーザー情報</td>
<td>ユーザー認証・管理</td>
</tr>
<tr>
<td><code>runs</code></td>
<td>走行記録</td>
<td>動画アップロード情報</td>
</tr>
<tr>
<td><code>keypoints</code></td>
<td>キーポイントデータ</td>
<td>骨格推定結果（33ランドマーク）</td>
</tr>
<tr>
<td><code>analysis_results</code></td>
<td>解析結果</td>
<td>Z値、角度などの計算結果</td>
</tr>
<tr>
<td><code>events</code></td>
<td>イベントデータ</td>
<td>足接地・離地のタイミング</td>
</tr>
<tr>
<td><code>advice</code></td>
<td>アドバイス</td>
<td>生成されたアドバイス（将来の拡張用）</td>
</tr>
</tbody>
</table>
<hr />
<h2>1. users テーブル</h2>
<p>ユーザー情報を管理するテーブル。</p>
<h3>スキーマ</h3>
<table>
<thead>
<tr>
<th>カラム名</th>
<th>データ型</th>
<th>制約</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user_id</code></td>
<td>VARCHAR(255)</td>
<td>PRIMARY KEY</td>
<td>ユーザーID（一意）</td>
</tr>
<tr>
<td><code>username</code></td>
<td>VARCHAR(255)</td>
<td>NOT NULL</td>
<td>ユーザー名</td>
</tr>
<tr>
<td><code>email</code></td>
<td>VARCHAR(255)</td>
<td>UNIQUE</td>
<td>メールアドレス</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>TIMESTAMP</td>
<td>DEFAULT NOW()</td>
<td>アカウント作成日時</td>
</tr>
<tr>
<td><code>updated_at</code></td>
<td>TIMESTAMP</td>
<td>DEFAULT NOW()</td>
<td>最終更新日時</td>
</tr>
</tbody>
</table>
<h3>データ例</h3>
<pre><code class="language-sql">user_id: &quot;default_user&quot;
username: &quot;Default User&quot;
email: &quot;default@example.com&quot;
created_at: 2025-10-03 07:50:00
updated_at: 2025-10-03 07:50:00
</code></pre>
<h3>用途</h3>
<ul>
<li>現在は <code>default_user</code> のみ使用</li>
<li>将来的にユーザー認証機能を追加する際の基盤</li>
</ul>
<hr />
<h2>2. runs テーブル</h2>
<p>動画アップロードごとの走行記録を管理するテーブル。</p>
<h3>スキーマ</h3>
<table>
<thead>
<tr>
<th>カラム名</th>
<th>データ型</th>
<th>制約</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>SERIAL</td>
<td>PRIMARY KEY</td>
<td>走行ID（自動採番）</td>
</tr>
<tr>
<td><code>user_id</code></td>
<td>VARCHAR(255)</td>
<td>FOREIGN KEY → users(user_id)</td>
<td>ユーザーID</td>
</tr>
<tr>
<td><code>video_id</code></td>
<td>VARCHAR(255)</td>
<td>UNIQUE, NOT NULL</td>
<td>動画の一意識別子（UUID）</td>
</tr>
<tr>
<td><code>video_path</code></td>
<td>TEXT</td>
<td></td>
<td>動画ファイルのサーバー上のパス</td>
</tr>
<tr>
<td><code>original_filename</code></td>
<td>VARCHAR(255)</td>
<td></td>
<td>アップロードされた元のファイル名</td>
</tr>
<tr>
<td><code>video_fps</code></td>
<td>DOUBLE PRECISION</td>
<td></td>
<td>動画のフレームレート</td>
</tr>
<tr>
<td><code>video_duration</code></td>
<td>DOUBLE PRECISION</td>
<td></td>
<td>動画の長さ（秒）</td>
</tr>
<tr>
<td><code>total_frames</code></td>
<td>INTEGER</td>
<td></td>
<td>動画の総フレーム数</td>
</tr>
<tr>
<td><code>analysis_status</code></td>
<td>VARCHAR(50)</td>
<td>DEFAULT 'processing'</td>
<td>解析ステータス</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>TIMESTAMP</td>
<td>DEFAULT NOW()</td>
<td>レコード作成日時</td>
</tr>
<tr>
<td><code>updated_at</code></td>
<td>TIMESTAMP</td>
<td>DEFAULT NOW()</td>
<td>最終更新日時</td>
</tr>
</tbody>
</table>
<h3>analysis_status の値</h3>
<ul>
<li><code>processing</code>: 処理中</li>
<li><code>completed</code>: 完了</li>
<li><code>failed</code>: 失敗</li>
</ul>
<h3>データ例</h3>
<pre><code class="language-sql">id: 6
user_id: &quot;default_user&quot;
video_id: &quot;837fdeca-a276-4a06-8746-d539581f3afe&quot;
video_path: &quot;/app/uploads/837fdeca-a276-4a06-8746-d539581f3afe.mov&quot;
original_filename: &quot;前傾.mov&quot;
video_fps: 30.00
video_duration: 4.17
total_frames: 125
analysis_status: &quot;completed&quot;
created_at: 2025-10-06 04:13:40
updated_at: 2025-10-06 04:13:50
</code></pre>
<h3>用途</h3>
<ul>
<li>動画アップロード情報の管理</li>
<li>解析ステータスの追跡</li>
<li>他のテーブルとの関連付け（外部キー）</li>
</ul>
<hr />
<h2>3. keypoints テーブル</h2>
<p>MediaPipe Poseで検出された骨格キーポイント（33ランドマーク）のデータを格納するテーブル。</p>
<h3>スキーマ</h3>
<table>
<thead>
<tr>
<th>カラム名</th>
<th>データ型</th>
<th>制約</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>SERIAL</td>
<td>PRIMARY KEY</td>
<td>レコードID（自動採番）</td>
</tr>
<tr>
<td><code>run_id</code></td>
<td>INTEGER</td>
<td>FOREIGN KEY → runs(id)</td>
<td>走行ID</td>
</tr>
<tr>
<td><code>frame_number</code></td>
<td>INTEGER</td>
<td>NOT NULL</td>
<td>フレーム番号（0始まり）</td>
</tr>
<tr>
<td><code>landmark_id</code></td>
<td>INTEGER</td>
<td>NOT NULL</td>
<td>ランドマークID（0-32）</td>
</tr>
<tr>
<td><code>landmark_name</code></td>
<td>VARCHAR(50)</td>
<td></td>
<td>ランドマーク名</td>
</tr>
<tr>
<td><code>x_coordinate</code></td>
<td>DOUBLE PRECISION</td>
<td></td>
<td>X座標（0.0-1.0の正規化値）</td>
</tr>
<tr>
<td><code>y_coordinate</code></td>
<td>DOUBLE PRECISION</td>
<td></td>
<td>Y座標（0.0-1.0の正規化値）</td>
</tr>
<tr>
<td><code>z_coordinate</code></td>
<td>DOUBLE PRECISION</td>
<td></td>
<td>Z座標（深度情報）</td>
</tr>
<tr>
<td><code>visibility</code></td>
<td>DOUBLE PRECISION</td>
<td></td>
<td>可視性スコア（0.0-1.0）</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>TIMESTAMP</td>
<td>DEFAULT NOW()</td>
<td>レコード作成日時</td>
</tr>
</tbody>
</table>
<h3>複合ユニーク制約</h3>
<pre><code class="language-sql">UNIQUE (run_id, frame_number, landmark_id)
</code></pre>
<h3>MediaPipe Pose ランドマーク一覧（33個）</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>landmark_name</th>
<th>日本語名</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>nose</td>
<td>鼻</td>
</tr>
<tr>
<td>1</td>
<td>left_eye_inner</td>
<td>左目（内側）</td>
</tr>
<tr>
<td>2</td>
<td>left_eye</td>
<td>左目</td>
</tr>
<tr>
<td>3</td>
<td>left_eye_outer</td>
<td>左目（外側）</td>
</tr>
<tr>
<td>4</td>
<td>right_eye_inner</td>
<td>右目（内側）</td>
</tr>
<tr>
<td>5</td>
<td>right_eye</td>
<td>右目</td>
</tr>
<tr>
<td>6</td>
<td>right_eye_outer</td>
<td>右目（外側）</td>
</tr>
<tr>
<td>7</td>
<td>left_ear</td>
<td>左耳</td>
</tr>
<tr>
<td>8</td>
<td>right_ear</td>
<td>右耳</td>
</tr>
<tr>
<td>9</td>
<td>mouth_left</td>
<td>口（左）</td>
</tr>
<tr>
<td>10</td>
<td>mouth_right</td>
<td>口（右）</td>
</tr>
<tr>
<td>11</td>
<td>left_shoulder</td>
<td>左肩</td>
</tr>
<tr>
<td>12</td>
<td>right_shoulder</td>
<td>右肩</td>
</tr>
<tr>
<td>13</td>
<td>left_elbow</td>
<td>左肘</td>
</tr>
<tr>
<td>14</td>
<td>right_elbow</td>
<td>右肘</td>
</tr>
<tr>
<td>15</td>
<td>left_wrist</td>
<td>左手首</td>
</tr>
<tr>
<td>16</td>
<td>right_wrist</td>
<td>右手首</td>
</tr>
<tr>
<td>17</td>
<td>left_pinky</td>
<td>左小指</td>
</tr>
<tr>
<td>18</td>
<td>right_pinky</td>
<td>右小指</td>
</tr>
<tr>
<td>19</td>
<td>left_index</td>
<td>左人差し指</td>
</tr>
<tr>
<td>20</td>
<td>right_index</td>
<td>右人差し指</td>
</tr>
<tr>
<td>21</td>
<td>left_thumb</td>
<td>左親指</td>
</tr>
<tr>
<td>22</td>
<td>right_thumb</td>
<td>右親指</td>
</tr>
<tr>
<td>23</td>
<td>left_hip</td>
<td>左腰</td>
</tr>
<tr>
<td>24</td>
<td>right_hip</td>
<td>右腰</td>
</tr>
<tr>
<td>25</td>
<td>left_knee</td>
<td>左膝</td>
</tr>
<tr>
<td>26</td>
<td>right_knee</td>
<td>右膝</td>
</tr>
<tr>
<td>27</td>
<td>left_ankle</td>
<td>左足首</td>
</tr>
<tr>
<td>28</td>
<td>right_ankle</td>
<td>右足首</td>
</tr>
<tr>
<td>29</td>
<td>left_heel</td>
<td>左かかと</td>
</tr>
<tr>
<td>30</td>
<td>right_heel</td>
<td>右かかと</td>
</tr>
<tr>
<td>31</td>
<td>left_foot_index</td>
<td>左足人差し指</td>
</tr>
<tr>
<td>32</td>
<td>right_foot_index</td>
<td>右足人差し指</td>
</tr>
</tbody>
</table>
<h3>データ例</h3>
<pre><code class="language-sql">id: 12345
run_id: 6
frame_number: 50
landmark_id: 27
landmark_name: &quot;left_ankle&quot;
x_coordinate: 0.4523
y_coordinate: 0.8234
z_coordinate: -0.0123
visibility: 0.9567
created_at: 2025-10-06 04:13:45
</code></pre>
<h3>データ量</h3>
<ul>
<li><strong>1フレームあたり</strong>: 33レコード（33ランドマーク）</li>
<li><strong>125フレームの動画</strong>: 約4,125レコード（実際は検出できなかったフレームがある場合、それより少ない）</li>
<li><strong>実測値（Run ID: 6）</strong>: 119フレーム検出、3,927レコード保存（95.2%の検出率）</li>
</ul>
<h3>用途</h3>
<ul>
<li>ランニングフォームの詳細分析</li>
<li>角度計算の基礎データ</li>
<li>時系列での動きの追跡</li>
</ul>
<hr />
<h2>4. analysis_results テーブル</h2>
<p>Z値分析や角度計算などの解析結果を格納するテーブル。</p>
<h3>スキーマ</h3>
<table>
<thead>
<tr>
<th>カラム名</th>
<th>データ型</th>
<th>制約</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>SERIAL</td>
<td>PRIMARY KEY</td>
<td>レコードID（自動採番）</td>
</tr>
<tr>
<td><code>run_id</code></td>
<td>INTEGER</td>
<td>FOREIGN KEY → runs(id)</td>
<td>走行ID</td>
</tr>
<tr>
<td><code>metric_name</code></td>
<td>VARCHAR(255)</td>
<td>NOT NULL</td>
<td>指標名</td>
</tr>
<tr>
<td><code>value</code></td>
<td>DOUBLE PRECISION</td>
<td>NOT NULL</td>
<td>計算値</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>TIMESTAMP</td>
<td>DEFAULT NOW()</td>
<td>レコード作成日時</td>
</tr>
</tbody>
</table>
<h3>metric_name の命名規則</h3>
<h4>Z値データ</h4>
<pre><code>Z値_{イベント種類}_{角度名}
</code></pre>
<p><strong>イベント種類:</strong>
- <code>right_strike</code>: 右足接地
- <code>right_off</code>: 右足離地
- <code>left_strike</code>: 左足接地
- <code>left_off</code>: 左足離地</p>
<p><strong>角度名:</strong>
- <code>体幹角度</code>: 体幹の前傾角度
- <code>左大腿角度</code>: 左大腿の角度
- <code>右大腿角度</code>: 右大腿の角度
- <code>左下腿角度</code>: 左下腿の角度
- <code>右下腿角度</code>: 右下腿の角度</p>
<h4>角度データ</h4>
<pre><code>角度_{イベント種類}_{角度名}
</code></pre>
<h3>データ例</h3>
<pre><code class="language-sql">-- Z値データ
id: 1001
run_id: 6
metric_name: &quot;Z値_left_off_体幹角度&quot;
value: 4.088
created_at: 2025-10-06 04:13:48

-- 角度データ
id: 1021
run_id: 6
metric_name: &quot;Z値_left_off_右下腿角度&quot;
value: -10.248
created_at: 2025-10-06 04:13:48
</code></pre>
<h3>Z値の解釈</h3>
<table>
<thead>
<tr>
<th>Z値の範囲</th>
<th>評価</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>|Z| &lt; 2.0</td>
<td>正常範囲</td>
<td>標準的なフォーム</td>
</tr>
<tr>
<td>2.0 ≤ |Z| &lt; 3.0</td>
<td>注意</td>
<td>やや標準から外れている</td>
</tr>
<tr>
<td>|Z| ≥ 3.0</td>
<td>要改善</td>
<td>標準から大きく外れている</td>
</tr>
</tbody>
</table>
<h3>データ量</h3>
<ul>
<li><strong>1回の解析あたり</strong>: 約15-40レコード（検出されたイベント数に依存）</li>
<li>Z値のみ保存（イベント種類 × 角度種類）</li>
<li><strong>実測値（Run ID: 6）</strong>: 15レコード保存</li>
</ul>
<h3>用途</h3>
<ul>
<li>フォーム分析結果の保存</li>
<li>経時的な改善の追跡</li>
<li>統計分析の基礎データ</li>
</ul>
<hr />
<h2>5. events テーブル</h2>
<p>足接地・離地のタイミング情報を格納するテーブル。</p>
<h3>スキーマ</h3>
<table>
<thead>
<tr>
<th>カラム名</th>
<th>データ型</th>
<th>制約</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>SERIAL</td>
<td>PRIMARY KEY</td>
<td>レコードID（自動採番）</td>
</tr>
<tr>
<td><code>run_id</code></td>
<td>INTEGER</td>
<td>FOREIGN KEY → runs(id)</td>
<td>走行ID</td>
</tr>
<tr>
<td><code>frame_number</code></td>
<td>INTEGER</td>
<td>NOT NULL</td>
<td>イベント発生フレーム番号</td>
</tr>
<tr>
<td><code>foot_side</code></td>
<td>VARCHAR(10)</td>
<td>NOT NULL</td>
<td>足の左右（'left' or 'right'）</td>
</tr>
<tr>
<td><code>event_type</code></td>
<td>VARCHAR(20)</td>
<td>NOT NULL</td>
<td>イベント種類</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>TIMESTAMP</td>
<td>DEFAULT NOW()</td>
<td>レコード作成日時</td>
</tr>
</tbody>
</table>
<h3>event_type の値</h3>
<table>
<thead>
<tr>
<th>値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>left_strike</code></td>
<td>左足接地</td>
</tr>
<tr>
<td><code>left_off</code></td>
<td>左足離地</td>
</tr>
<tr>
<td><code>right_strike</code></td>
<td>右足接地</td>
</tr>
<tr>
<td><code>right_off</code></td>
<td>右足離地</td>
</tr>
</tbody>
</table>
<h3>データ例</h3>
<pre><code class="language-sql">id: 501
run_id: 6
frame_number: 15
foot_side: &quot;left&quot;
event_type: &quot;left_strike&quot;
created_at: 2025-10-06 04:13:47
</code></pre>
<h3>データ量</h3>
<ul>
<li><strong>1回の解析あたり</strong>: 10-20レコード（動画の長さに依存）</li>
<li><strong>平均的な4秒の動画</strong>: 約19レコード</li>
<li>左足接地: 5-6回</li>
<li>左足離地: 5-6回</li>
<li>右足接地: 4-5回</li>
<li>右足離地: 4-5回</li>
<li><strong>実測値（Run ID: 6）</strong>: 19レコード</li>
<li>left_strike: 6件（フレーム 10〜115）</li>
<li>left_off: 5件（フレーム 19〜104）</li>
<li>right_strike: 4件（フレーム 5〜102）</li>
<li>right_off: 4件（フレーム 32〜114）</li>
</ul>
<h3>用途</h3>
<ul>
<li>ランニングサイクルの特定</li>
<li>ピッチ（歩数/分）の計算</li>
<li>接地時間の計算</li>
<li>左右バランスの分析</li>
</ul>
<hr />
<h2>6. advice テーブル</h2>
<p>生成されたアドバイス情報を格納するテーブル（将来の拡張用）。</p>
<h3>スキーマ</h3>
<table>
<thead>
<tr>
<th>カラム名</th>
<th>データ型</th>
<th>制約</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>SERIAL</td>
<td>PRIMARY KEY</td>
<td>レコードID（自動採番）</td>
</tr>
<tr>
<td><code>run_id</code></td>
<td>INTEGER</td>
<td>FOREIGN KEY → runs(id)</td>
<td>走行ID</td>
</tr>
<tr>
<td><code>issue</code></td>
<td>TEXT</td>
<td></td>
<td>検出された課題</td>
</tr>
<tr>
<td><code>advice_text</code></td>
<td>TEXT</td>
<td></td>
<td>アドバイス内容</td>
</tr>
<tr>
<td><code>priority</code></td>
<td>VARCHAR(20)</td>
<td></td>
<td>優先度（'high', 'medium', 'low'）</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>TIMESTAMP</td>
<td>DEFAULT NOW()</td>
<td>レコード作成日時</td>
</tr>
</tbody>
</table>
<h3>現在の状態</h3>
<ul>
<li><strong>現在は未使用</strong>（0件）</li>
<li>アドバイスは現在、API レスポンスとして返されるのみ</li>
<li>将来的に、過去のアドバイス履歴を保存・参照する機能を実装する際に使用予定</li>
</ul>
<hr />
<h2>データフロー</h2>
<h3>1. 動画アップロード時</h3>
<pre><code>1. users テーブル確認
   ↓
2. runs テーブルに新規レコード作成
   ├─ user_id: &quot;default_user&quot;
   ├─ video_id: UUID生成
   ├─ analysis_status: &quot;processing&quot;
   └─ 動画メタデータ（FPS、長さ、フレーム数）
   ↓
3. 骨格推定実行
   ↓
4. keypoints テーブルに一括保存
   └─ 全フレーム × 33ランドマーク
   ↓
5. Z値分析実行
   ↓
6. events テーブルに保存
   └─ 足接地・離地イベント
   ↓
7. analysis_results テーブルに保存
   ├─ Z値データ（20件）
   └─ 角度データ（20件）
   ↓
8. runs テーブルのステータス更新
   └─ analysis_status: &quot;completed&quot;
</code></pre>
<h3>2. 結果表示時</h3>
<pre><code>1. runs テーブルから走行情報取得
   ↓
2. keypoints テーブルから骨格データ取得
   ↓
3. analysis_results テーブルから解析結果取得
   ↓
4. events テーブルからイベント情報取得
   ↓
5. フロントエンドで可視化
</code></pre>
<hr />
<h2>インデックス</h2>
<h3>既存のインデックス</h3>
<ol>
<li><strong>PRIMARY KEY インデックス</strong> (各テーブル)</li>
<li>
<p>自動的に作成される</p>
</li>
<li>
<p><strong>UNIQUE制約インデックス</strong></p>
</li>
<li><code>users(user_id)</code></li>
<li><code>runs(video_id)</code></li>
<li>
<p><code>keypoints(run_id, frame_number, landmark_id)</code></p>
</li>
<li>
<p><strong>FOREIGN KEY インデックス</strong></p>
</li>
<li>自動的に作成される</li>
</ol>
<h3>推奨される追加インデックス（将来の最適化用）</h3>
<pre><code class="language-sql">-- 頻繁に検索されるカラムにインデックスを追加
CREATE INDEX idx_runs_user_id ON runs(user_id);
CREATE INDEX idx_runs_created_at ON runs(created_at DESC);
CREATE INDEX idx_keypoints_run_id ON keypoints(run_id);
CREATE INDEX idx_keypoints_frame_number ON keypoints(run_id, frame_number);
CREATE INDEX idx_analysis_results_run_id ON analysis_results(run_id);
CREATE INDEX idx_events_run_id ON events(run_id);
</code></pre>
<hr />
<h2>データサイズの見積もり</h2>
<h3>典型的な4秒の動画（125フレーム）の場合</h3>
<table>
<thead>
<tr>
<th>テーブル</th>
<th>レコード数</th>
<th>1レコードサイズ（概算）</th>
<th>合計サイズ</th>
</tr>
</thead>
<tbody>
<tr>
<td>runs</td>
<td>1</td>
<td>500 bytes</td>
<td>500 bytes</td>
</tr>
<tr>
<td>keypoints</td>
<td>3,927</td>
<td>100 bytes</td>
<td>約380 KB</td>
</tr>
<tr>
<td>analysis_results</td>
<td>15</td>
<td>80 bytes</td>
<td>約1.2 KB</td>
</tr>
<tr>
<td>events</td>
<td>19</td>
<td>60 bytes</td>
<td>約1.1 KB</td>
</tr>
<tr>
<td><strong>合計</strong></td>
<td><strong>3,962</strong></td>
<td>-</td>
<td><strong>約383 KB</strong></td>
</tr>
</tbody>
</table>
<p><strong>実測値（2025年10月6日時点）:</strong>
- 総runs数: 3件
- 総keypoints数: 7,887件
- 総analysis_results数: 80件
- 総events数: 38件</p>
<h3>年間のデータ増加見積もり</h3>
<p><strong>仮定:</strong>
- 1日あたり100動画アップロード
- 年間稼働日数: 365日</p>
<p><strong>年間データ量:</strong>
- レコード数: 約145万レコード
- データサイズ: 約14 GB</p>
<hr />
<h2>バックアップとメンテナンス</h2>
<h3>推奨事項</h3>
<ol>
<li><strong>定期バックアップ</strong></li>
<li>日次: 自動バックアップ（AWS RDS機能）</li>
<li>
<p>週次: 手動スナップショット</p>
</li>
<li>
<p><strong>古いデータのアーカイブ</strong></p>
</li>
<li>6ヶ月以上前のデータは別テーブルに移動</li>
<li>
<p>または圧縮して保存</p>
</li>
<li>
<p><strong>インデックスの再構築</strong></p>
</li>
<li>月次でVACUUM ANALYZE実行</li>
</ol>
<hr />
<h2>セキュリティ</h2>
<h3>アクセス制御</h3>
<ul>
<li><strong>アプリケーション用ユーザー</strong>: 読み書き権限</li>
<li><strong>管理者ユーザー</strong>: 全権限</li>
<li><strong>読み取り専用ユーザー</strong>: SELECT権限のみ</li>
</ul>
<h3>機密データ</h3>
<ul>
<li>現在、個人情報は最小限（メールアドレスのみ）</li>
<li>将来的にユーザー認証を追加する場合は、パスワードのハッシュ化が必須</li>
</ul>
<hr />
<h2>バージョン履歴</h2>
<table>
<thead>
<tr>
<th>バージョン</th>
<th>日付</th>
<th>変更内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.0</td>
<td>2025-10-03</td>
<td>初版作成</td>
</tr>
<tr>
<td>1.1</td>
<td>2025-10-06</td>
<td>データベースエンドポイント変更（cluster → single）、実測値追加、データ例更新</td>
</tr>
</tbody>
</table>
<hr />
<h2>関連ドキュメント</h2>
<ul>
<li><code>database_schema.sql</code>: テーブル作成SQLスクリプト</li>
<li><code>DATABASE_INTEGRATION_README.md</code>: データベース統合の概要</li>
<li><code>DATABASE_SETUP_GUIDE.md</code>: データベースセットアップガイド</li>
</ul>
    </div>
</body>
</html>
