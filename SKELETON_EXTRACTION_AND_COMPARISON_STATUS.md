# 骨格推定と標準モデル比較機能の現状まとめ

## 📋 概要

ランニングフォーム分析システムにおいて、動画から骨格を抽出し、標準モデルと比較する機能を実装しています。現在、骨格抽出の精度に課題があり、改善を進めています。

---

## 🎯 実装している機能

### 1. 骨格抽出機能（Pose Estimation）

**技術スタック:**
- **バックエンド**: MediaPipe Pose（model_complexity=2、最高精度モデル）
- **フロントエンド**: Next.js + React + Canvas API

**処理フロー:**
1. ユーザーが動画をアップロード
2. `pose_estimation`サービスが動画の各フレームを処理
3. MediaPipe Poseで33個のキーポイントを検出
4. フレーム間スムージング（過去5フレームの移動平均）
5. キーポイントデータをJSON形式で返却

**現在の設定:**
- `min_detection_confidence=0.1`
- `min_tracking_confidence=0.1`
- `smooth_landmarks=True`（MediaPipeの内部スムージング）
- 可視性閾値: 0.05（低）、0.5（高）

### 2. 標準モデルとの比較機能

**実装内容:**
- **上段**: アップロードした動画のリプレイ
- **下段**: 2つのキャンバスで棒人間を比較
  - **左**: 標準モデルの棒人間（s-motion_girl_Velocity2.sdから生成）
  - **右**: ユーザーの走り（1周期）の棒人間

**標準モデルのデータソース:**
- `s-motion_girl_Velocity2.sd`（24キーポイントの3D座標データ）
- これをMediaPipeの33-landmark形式に変換
- 座標を0-1の範囲に正規化

**ユーザー1周期の抽出:**
- `z_score_analysis.selected_cycle`から1周期を抽出
- フォールバック: 最初の200フレームを表示

**アニメーション:**
- 30 FPSでアニメーションループ
- 標準モデルとユーザーのペースを自動調整

---

## ⚠️ 現在の問題点

### 1. 骨格抽出の精度が低い

**症状:**
- ローカル環境: 骨格は表示されるが、動きが不自然
- EC2環境: 骨格が縦一直線や変な動きになる
- 特定のフレームで巨大な棒人間が表示される

**原因の仮説:**
1. **MediaPipeの検出精度の問題**
   - 動画の品質（解像度、フレームレート、照明条件）に依存
   - ランニング動作の検出が難しい（動きが速い、被写体が小さい）

2. **座標の正規化の問題**
   - MediaPipeの座標は0-1の範囲に正規化されている
   - 座標系の解釈が間違っている可能性（X/Y/Z軸の対応）
   - 異常に大きな値が来た場合の処理が不十分

3. **スムージングの問題**
   - 過去5フレームの移動平均を使用
   - スムージングが強すぎて、実際の動きを滑らかにしすぎている可能性

### 2. 標準モデルとの比較がうまく機能していない

**問題:**
- 標準モデルが動かない（アニメーションが動作しない）
- ユーザー1周期の抽出がうまくいかない（`z_score_analysis.selected_cycle`が取得できない）
- 2つの棒人間のペースが合わない

**現在の対応:**
- フォールバック: 最初の200フレームを表示
- ペース調整機能を実装（ユーザーのアニメーション速度を標準モデルに合わせる）

### 3. ピッチ（ケイデンス）計算の問題

**問題:**
- サイクル検出の精度が低い
- スローモーション動画でおかしい数値が出る
- フットストライク検出が不安定

**現在の対応:**
- ピッチの表示を一時的に非表示に変更（曖昧なデータを表示しない）

---

## 🔧 試行した改善策（効果がなかったもの）

### Phase 1の改善（一部実装済み）

1. **前処理の最適化**
   - ガウシアンブラーとバイラテラルフィルターの併用をやめる
   - CLAHEのパラメータ調整
   - シャープ化の強度調整
   - **結果**: 効果は限定的

2. **MediaPipe設定の最適化**
   - `smooth_landmarks=True`を追加
   - **結果**: 軽微な改善

3. **動画品質の事前チェック**
   - 解像度、フレームレートのチェック
   - 明るさの自動補正
   - **結果**: 警告は表示されるが、精度向上は限定的

### 異常値検出と補正（削除済み）

1. **フレーム間の急激な移動チェック**
   - 前フレームとの距離が0.3以上の場合、前フレームの値を使用
   - **結果**: 逆効果（異常フレームが増加）

2. **物理的制約チェック**
   - 骨の長さが急激に変化した場合の補正
   - **結果**: 逆効果（巨大な棒人間が増加）

3. **座標の強制クリップ**
   - 0-1の範囲に強制クリップ
   - **結果**: 効果なし

**結論**: これらの修正は逆効果だったため、すべて削除して元の状態に戻しました。

---

## 📁 関連ファイル

### バックエンド

**`backend/services/pose_estimation/app/main.py`**
- 骨格抽出のメインロジック
- MediaPipe Poseの設定と処理
- フレーム間スムージング

**`backend/services/feature_extraction/app/standard_model_from_coordinates.py`**
- 標準モデルの座標データをMediaPipe形式に変換

**`backend/services/feature_extraction/app/main.py`**
- `/standard_model/keypoints`エンドポイント
- 標準モデルのキーポイントデータを返却

### フロントエンド

**`frontend/app/components/PoseVisualizer.tsx`**
- 骨格の描画ロジック
- 標準モデルとユーザー1周期の比較表示
- 座標の正規化とスケーリング

**`frontend/app/result/[id]/page.tsx`**
- 結果表示ページ
- ピッチの表示（現在は非表示）

---

## 🎨 UI構成

```
┌─────────────────────────────────────┐
│  動画プレイヤー（上段）              │
│  - アップロードした動画のリプレイ    │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  棒人間同士の比較（下段）            │
│  ┌──────────┐  ┌──────────┐        │
│  │標準モデル│  │あなたの  │        │
│  │（左）    │  │走り      │        │
│  │          │  │（右）    │        │
│  └──────────┘  └──────────┘        │
└─────────────────────────────────────┘
```

---

## 🔍 現在の技術的課題

### 1. 座標系の解釈

**問題:**
- MediaPipeの座標（X, Y, Z）がどの物理方向に対応しているか不明確
- X座標の範囲が非常に狭い場合がある（0.1以下）
- Z座標をX座標として使用する試みを実装したが、効果は限定的

**現在の処理:**
```typescript
// X座標の範囲が狭い場合、Z座標をX座標として使用
if (xRange < 0.1 || xMin < 0 || xMax > 1) {
  if (zRange > xRange * 2) {
    useZForX = true  // Z座標をX座標として使用
  }
}
```

### 2. 可視性の閾値

**現在の設定:**
- `VISIBILITY_THRESHOLD_LOW = 0.05`
- `VISIBILITY_THRESHOLD_HIGH = 0.5`

**問題:**
- 可視性が低いキーポイントを表示すると、ノイズが増える
- 可視性が高いキーポイントのみを表示すると、骨格が不完全になる

### 3. スムージングの強度

**現在の設定:**
- 過去5フレームの移動平均
- 線形重み付け（新しいフレームほど重い）

**問題:**
- スムージングが強すぎると、実際の動きが滑らかになりすぎる
- スムージングが弱すぎると、ノイズが多くなる

---

## 📊 データフロー

```
動画アップロード
    ↓
pose_estimationサービス
    ↓
MediaPipe Pose処理（各フレーム）
    ↓
キーポイント抽出（33個）
    ↓
フレーム間スムージング
    ↓
JSON形式で返却
    ↓
フロントエンドで描画
    ↓
標準モデルと比較表示
```

---

## 🚀 次のステップ（検討事項）

### 1. 骨格抽出精度の改善

**検討すべきアプローチ:**
1. **MediaPipeの代替検討**
   - YOLO Pose
   - OpenPose
   - MediaPipeの最新版

2. **前処理の見直し**
   - 動画の品質に応じた前処理の調整
   - 解像度の最適化（アップスケール/ダウンスケール）

3. **後処理の改善**
   - より高度なスムージングアルゴリズム（カルマンフィルターなど）
   - 物理的制約を考慮した補正（骨の長さ、関節角度の範囲）

### 2. 標準モデルとの比較機能の改善

**検討すべきアプローチ:**
1. **サイクル検出の改善**
   - `z_score_analysis`の精度向上
   - フォールバックロジックの改善

2. **アニメーション同期の改善**
   - より正確なペース調整
   - タイムスタンプベースの同期

### 3. 座標系の解釈の明確化

**検討すべきアプローチ:**
1. **座標データの分析**
   - 実際の動画データの座標範囲を分析
   - X/Y/Z軸の物理的意味を明確化

2. **テストデータの作成**
   - 既知の動きをするテスト動画を作成
   - 座標の期待値を事前に定義

---

## 📝 参考資料

- `POSE_EXTRACTION_IMPROVEMENT_PLAN.md`: 骨格抽出精度改善プラン（詳細）
- `coordinate_transition.csv`: 座標データの推移（分析用）
- `s-motion_girl_Velocity2.sd`: 標準モデルの座標データ

---

## 🎯 現在の優先度

1. **最優先**: 骨格抽出の精度向上（巨大な棒人間や縦一直線の問題を解決）
2. **高**: 標準モデルとの比較機能の安定化（アニメーション、サイクル抽出）
3. **中**: 座標系の解釈の明確化
4. **低**: ピッチ計算の改善（現在は非表示）

---

## 💡 相談したいポイント

1. **MediaPipe Poseの精度向上方法**
   - 動画の品質が低い場合の対処法
   - ランニング動作の検出精度を上げる方法

2. **座標系の解釈**
   - MediaPipeの座標（X, Y, Z）の物理的意味
   - 座標の正規化とスケーリングの最適な方法

3. **スムージングアルゴリズム**
   - フレーム間のスムージングの最適な方法
   - ノイズを減らしつつ、実際の動きを保つ方法

4. **異常値の処理**
   - 異常なキーポイントを検出する方法
   - 異常値を補正する最適な方法（補間、前フレームの使用など）

5. **標準モデルとの比較**
   - サイクル検出の精度向上方法
   - アニメーション同期の改善方法

---

最終更新: 2026年1月27日
