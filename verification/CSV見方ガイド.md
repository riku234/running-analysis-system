# CSV見方ガイド - ランニング解析データ

## 📊 CSVファイルの構造

全19列からなるCSVファイルです。

### 列の構成

```
A-H列:   既存データ（骨格情報）
I-M列:   角度データ
N-S列:   イベント＆Zスコアデータ
```

---

## 📋 各列の説明

### 【A-H列】骨格データ（全フレーム・全ランドマークに値あり）

| 列 | 列名 | 説明 | 値の例 |
|---|------|------|--------|
| A | `frame_number` | フレーム番号（0から開始） | 0, 1, 2... |
| B | `timestamp` | タイムスタンプ（秒） | 0.0, 0.0333... |
| C | `confidence_score` | 検出信頼度（0-1） | 0.867 |
| D | `landmark` | ランドマーク名（33種類） | nose, left_knee... |
| E | `x_coordinate` | X座標（正規化済み 0-1） | 0.063378 |
| F | `y_coordinate` | Y座標（正規化済み 0-1） | 0.318524 |
| G | `visibility` | 可視性スコア（0-1） | 1.0 |
| H | `body_part` | 身体部位 | 顔、上肢、体幹、下肢 |

### 【I-M列】角度データ（全フレームにあるが、一部空欄あり）

| 列 | 列名 | 説明 | 空欄の理由 |
|---|------|------|-----------|
| I | `trunk_angle` | 体幹角度（度） | 検出失敗時 |
| J | `left_thigh_angle` | 左大腿角度（度） | 左足が画面外など |
| K | `right_thigh_angle` | 右大腿角度（度） | 右足が画面外など |
| L | `left_lower_leg_angle` | 左下腿角度（度） | 左足が画面外など |
| M | `right_lower_leg_angle` | 右下腿角度（度） | 右足が画面外など |

**⚠️ 重要**: 角度データは各フレームに1セットだけです。そのため、同じフレーム内の全33ランドマークの行に**同じ角度値**が入ります。

### 【N-S列】イベント＆Zスコアデータ（最良サイクルのみ値あり）

| 列 | 列名 | 説明 | 値の例 |
|---|------|------|--------|
| N | `event_type` | イベント種類 | right_strike, left_off など |
| O | `z_score_trunk` | 体幹角度のZスコア | -0.538 |
| P | `z_score_left_thigh` | 左大腿角度のZスコア | 2.124 |
| Q | `z_score_right_thigh` | 右大腿角度のZスコア | -0.219 |
| R | `z_score_left_lower` | 左下腿角度のZスコア | 1.995 |
| S | `z_score_right_lower` | 右下腿角度のZスコア | -3.297 |

---

## ⭐ 最良サイクルとは？（本番システムロジック）

### システムの動作フロー

```
1. 全イベント検出 → 20イベント（例）
           ↓
2. サイクル候補抽出 → 複数のサイクル候補
           ↓
3. サイクル品質評価（各候補にスコア付け）
   - 時間間隔の適切さ（0.6-1.2秒）
   - イベント順序の正確さ
   - 間隔の均等性
   - データ品質（信頼度）
           ↓
4. 最良サイクル選択 → 1サイクル（4イベント）
           ↓
5. 角度データとの照合（RMSE法）
   - 各イベントタイプごとに
   - 全角度データとの誤差を計算
   - 最も一致する1フレームを選択
           ↓
6. Z値計算 → 4フレームのみ
```

### CSV生成ロジック（本番システム完全準拠）

1. **全イベントをN列に記録**（例：20フレーム）
2. **最良サイクルの4フレームを特定**（RMSE法で各イベントタイプごとに最良の1フレーム）
3. **最良サイクルの4フレームのみO-S列にZ値を記録**

---

## 📊 実際のデータ例

### このCSVのケース

| 項目 | 値 |
|-----|-----|
| 総フレーム数 | 261フレーム |
| 全イベント数 | 20イベント（N列に記録） |
| 最良サイクル | **4イベント**（O-S列にZ値） |
| Z値割合 | 20%（4/20イベント） |

### 最良サイクルの詳細

| イベント | フレーム | 体幹角度 | Z値 | 説明 |
|---------|---------|----------|-----|------|
| right_strike | 47 | 1.00° | -0.962 | 右足接地 |
| right_off | 52 | 0.57° | -1.211 | 右足離地 |
| left_strike | 140 | 2.05° | -0.538 | 左足接地 |
| left_off | 254 | 1.90° | -1.153 | 左足離地 |

---

## ❓ なぜ一部の列が空欄なのか？

### 理由1: 角度データ（I-M列）の空欄

**原因**: 
- 該当する身体部位が画面外にある
- ランドマークの検出信頼度が低い
- 姿勢的に角度計算が不可能

**例**:
```csv
0,0.0,0.867,nose,0.063,0.318,1.0,顔,1.71,,-11.28,,-2.16,,,,,,
```
→ フレーム0では左足が画面外のため、J列（left_thigh_angle）とL列（left_lower_leg_angle）が空欄

### 理由2: Zスコア（O-S列）の空欄

**原因**: 
- そのフレームが**最良サイクルの4イベントに含まれていない**
- 同じイベントタイプでも、最良サイクルに選ばれたフレームのみにZ値がある

**例**:
```csv
通常のイベントフレーム（最良サイクルではない）:
5,0.167,0.889,nose,...,1.35,4.24,-10.69,81.3,2.1,left_strike,,,,,
                                                   ↑N列にイベントあり、O-S列は空欄

最良サイクルのイベントフレーム:
140,4.667,0.92,nose,...,2.05,...,left_strike,-0.538,2.124,-0.219,1.995,-3.297
                                      ↑N列にイベント、O-S列にZ値あり
```

**重要ポイント**:
- `left_strike`イベントは複数回検出される（例：フレーム5, 52, 140, 200など）
- しかし、Z値があるのは**最良サイクルに選ばれた1回のみ**（フレーム140）

---

## 📊 CSVデータの構造イメージ

```
フレーム5（イベントだが最良サイクルではない）
├─ nose:              角度データあり、イベントあり、Zスコアなし
├─ left_eye_inner:    角度データあり、イベントあり、Zスコアなし
├─ ...（33行）        N列までデータ、O-S列は空欄
└─ right_foot_index:  角度データあり、イベントあり、Zスコアなし

フレーム140（最良サイクルのイベント）
├─ nose:              角度データあり、イベントあり、Zスコアあり ⭐
├─ left_eye_inner:    角度データあり、イベントあり、Zスコアあり ⭐
├─ ...（33行）        全列にデータあり
└─ right_foot_index:  角度データあり、イベントあり、Zスコアあり ⭐
```

---

## 🔍 最良サイクルの見つけ方

### 方法1: ExcelでN列（event_type）とO列（z_score_trunk）をフィルタ

1. CSVをExcelで開く
2. N列でフィルタ → 空白以外を選択（全イベントが表示）
3. O列でフィルタ → 空白以外を選択（**最良サイクルの4イベントのみ表示**）

### 方法2: コマンドラインで検索

```bash
# 最良サイクルのイベントを検索（O列に値がある行）
awk -F',' 'NR>1 && $15!="" {print $0}' enhanced_58bc828c_utf8_v3.csv | head -4

# 最良サイクルのフレーム番号のみ取得
awk -F',' 'NR>1 && $15!="" {print $1}' enhanced_58bc828c_utf8_v3.csv | sort -n | uniq
# → 47, 52, 140, 254
```

---

## 📈 データの活用方法

### 1. 全フレームの角度推移を見る

- I-M列（角度データ）をグラフ化
- 時間経過での体幹・脚の動きを可視化

### 2. 最良サイクルでのフォーム評価

- N列とO列でフィルタして最良サイクルのみ表示
- 接地時（strike）と離地時（off）の角度とZ値を比較

### 3. Zスコアでフォーム評価

- O-S列（Zスコア）を確認
- |Z| > 2.0 の場合、標準から大きく外れている
- |Z| > 3.0 の場合、要改善

### 4. 全イベントパターンの把握

- N列（event_type）でフィルタ
- 接地・離地のタイミングと頻度を確認
- 最良サイクル以外のイベントも観察可能

---

## 🎯 イベント種類

| イベント名 | 意味 | 重要度 |
|-----------|------|--------|
| `right_strike` | 右足接地 | ⭐⭐⭐ |
| `right_off` | 右足離地 | ⭐⭐ |
| `left_strike` | 左足接地 | ⭐⭐⭐ |
| `left_off` | 左足離地 | ⭐⭐ |

**ランニングサイクル**: 右足接地 → 右足離地 → 左足接地 → 左足離地 → （繰り返し）

---

## 📊 列の対応表（Excel用）

| Excel列 | 列番号 | 列名 | データ範囲 |
|---------|-------|------|-----------|
| A | 1 | frame_number | 全フレーム |
| B | 2 | timestamp | 全フレーム |
| C | 3 | confidence_score | 全フレーム |
| D | 4 | landmark | 全フレーム |
| E | 5 | x_coordinate | 全フレーム |
| F | 6 | y_coordinate | 全フレーム |
| G | 7 | visibility | 全フレーム |
| H | 8 | body_part | 全フレーム |
| I | 9 | trunk_angle | 全フレーム（一部空欄） |
| J | 10 | left_thigh_angle | 全フレーム（一部空欄） |
| K | 11 | right_thigh_angle | 全フレーム（一部空欄） |
| L | 12 | left_lower_leg_angle | 全フレーム（一部空欄） |
| M | 13 | right_lower_leg_angle | 全フレーム（一部空欄） |
| N | 14 | event_type | イベントフレームのみ（20件） |
| O | 15 | z_score_trunk | **最良サイクルのみ（4件）** ⭐ |
| P | 16 | z_score_left_thigh | **最良サイクルのみ（4件）** ⭐ |
| Q | 17 | z_score_right_thigh | **最良サイクルのみ（4件）** ⭐ |
| R | 18 | z_score_left_lower | **最良サイクルのみ（4件）** ⭐ |
| S | 19 | z_score_right_lower | **最良サイクルのみ（4件）** ⭐ |

---

## ✅ データの読み方まとめ

1. **1行 = 1フレーム内の1つのランドマーク**
   - 例: フレーム0のnose、フレーム0のleft_knee など

2. **同じフレームの全ランドマーク（33行）には同じ角度データが入る**
   - 角度はフレーム単位で計算されるため

3. **N列（event_type）は全イベントに値がある**
   - 約8%のフレームがイベントフレーム（20/261フレーム）

4. **O-S列（Zスコア）は最良サイクルの4イベントのみに値がある**
   - イベントフレームの20%（4/20イベント）
   - **本番システムと完全一致**

5. **空欄は「データがない」ではなく「該当しない」**
   - 角度: 検出失敗または計算不可
   - Zスコア: 最良サイクル以外のイベント

---

## 🔬 本番システムとの整合性

### 検証結果

| 項目 | 本番システム | CSV | 一致 |
|-----|------------|-----|------|
| Z値イベント数 | 4 | 4 | ✅ |
| right_strike | フレーム47 | フレーム47 | ✅ |
| right_off | フレーム52 | フレーム52 | ✅ |
| left_strike | フレーム140 | フレーム140 | ✅ |
| left_off | フレーム254 | フレーム254 | ✅ |
| Z値（right_strike） | -0.962 | -0.962 | ✅ |
| Z値（right_off） | -1.211 | -1.211 | ✅ |
| Z値（left_strike） | -0.538 | -0.538 | ✅ |
| Z値（left_off） | -1.153 | -1.153 | ✅ |

**🎉 本番システムと完全一致しています！**

---

## ⚠️ 重要な注意事項

### Zスコアの解釈

1. **Zスコアは最良サイクルの4イベントのみ計算されています**
2. **同じイベントタイプでも、最良サイクルに選ばれた1回のみにZ値があります**
3. **フォーム評価にはO-S列に値がある行のみを使用してください**

### 例：left_strikeイベントの場合

```
フレーム5:   left_strike | 角度1.35° | Zスコア（空欄）← 評価対象外
フレーム52:  left_strike | 角度4.24° | Zスコア（空欄）← 評価対象外
フレーム140: left_strike | 角度2.05° | Zスコア-0.538 ← 評価に使用 ⭐
フレーム200: left_strike | 角度2.8°  | Zスコア（空欄）← 評価対象外
```

→ **left_strikeイベントは4回検出されるが、Z値はフレーム140のみ**

---

## 🎓 用語解説

### RMSE（Root Mean Square Error）
- 複数の角度データ間の誤差を総合的に評価する指標
- 本番システムが最良サイクルを特定する際に使用
- 値が小さいほど、APIの目標角度に近い

### 最良サイクル
- 複数のサイクル候補の中から、品質スコアが最も高い1サイクル
- 時間間隔、イベント順序、均等性、データ品質の総合評価
- フォーム分析に使用される唯一のサイクル

### イベント検出
- 足の接地・離地のタイミングを自動検出
- 動画全体で複数回検出される
- 全てがCSVに記録されるが、Z値は最良サイクルのみ

---

**作成日**: 2025年10月23日  
**更新日**: 2025年10月23日（v3.0 - 本番システム完全準拠）  
**対象CSV**: enhanced_58bc828c_utf8_v3.csv, enhanced_58bc828c_sjis_v3.csv  
**ロジック**: 本番システムと同一（RMSE法による最良フレーム特定）
