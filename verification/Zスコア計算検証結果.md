# Zスコア計算検証結果

## 🔍 検証実施日
2025年10月23日

## 📊 検証対象
- ファイル: `enhanced_58bc828c_utf8.csv`
- Video ID: `58bc828c-49e5-457e-84f5-b1eaa8c80d8f`

---

## ✅ システムの動作仕様

### Z値分析の手順

1. **全イベント検出**
   - 動画全体から足接地・離地イベントを検出
   - 例: 20イベント検出

2. **最良サイクルの選択**
   - 複数のサイクル候補の中から品質スコアが最高のもの を1つ選択
   - 選択基準:
     - 時間間隔の適切さ（0.6-1.2秒）
     - イベント順序の正確さ
     - イベント間隔の均等性
     - データ品質（信頼度）

3. **選択されたサイクルのみでZスコア計算**
   - 最良サイクル内の4つのイベント（right_strike, right_off, left_strike, left_off）の角度のみ使用
   - 他のイベントはZスコア計算対象外

4. **全イベントフレームに同じZスコアを適用**
   - **重要**: CSVには選択されたサイクルのZスコアが、全イベントフレームにコピーされている

---

## ⚠️ 発見された問題

### 問題1: Zスコアの計算値が合わない

**検証結果（left_strike イベント - フレーム5）:**

| 角度名 | 実測値 | 標準平均 | 標準偏差 | 手計算Z値 | CSV記録Z値 | 誤差 |
|--------|--------|---------|---------|----------|-----------|------|
| 体幹角度 | 1.35° | 3.7095° | 3.3154° | **-0.712** | -0.538 | 0.174 |
| 左大腿角度 | 4.24° | -15.0547° | 12.7922° | **1.508** | 2.124 | 0.616 |
| 右大腿角度 | -10.69° | 1.2450° | 11.5915° | **-1.030** | -0.219 | 0.811 |
| 左下腿角度 | 81.30° | 2.8682° | 24.8263° | **3.159** | 1.995 | 1.164 |
| 右下腿角度 | 2.10° | 63.5634° | 25.0095° | **-2.458** | -3.297 | 0.839 |

**結論**: すべてのZスコアが手計算と一致しない（誤差: 0.17～1.16）

---

## 🤔 考えられる原因

### 仮説1: 別のフレームの角度が使われている
- 可能性: 最良サイクルとして選択されたのは別のフレーム
- CSVのフレーム5は最良サイクルのleft_strikeではない

### 仮説2: 複数イベントの平均値が使われている
- 可能性: 同じイベントタイプの複数フレームの平均角度
- コードを確認したが、そのようなロジックは見当たらない

### 仮説3: 選択されたサイクルとCSVの対応が間違っている
- **最も可能性が高い**
- システムは最良サイクルの4イベントのみでZ値を計算
- しかしCSVには全20イベントフレームにZ値が入っている
- → CSVのフレーム5は最良サイクルのイベントではない可能性

---

## 📋 確認が必要な項目

### 1. 最良サイクルの特定
**確認方法**: API レスポンスの `selected_cycle` を確認

```json
"selected_cycle": {
  "events": {
    "right_strike": XX,
    "right_off": XX,
    "left_strike": XX,  // ← これがフレーム5か？
    "left_off": XX
  }
}
```

### 2. CSVへの書き込みロジック
**問題点**: 
- システムは1サイクルのみでZ値計算
- しかしCSVには全20イベントフレームにZ値が入っている
- → スクリプト（generate_enhanced_csv.py）側で不適切に全イベントにコピーしている？

---

## 🔧 推奨される修正

### オプション1: CSVに最良サイクルのイベントのみ記載
```csv
フレーム5  ... left_strike  （空欄）
フレームXX ... left_strike  -0.538, 2.124, ...  ← 最良サイクルのみZ値あり
フレーム47 ... right_strike （空欄）
```

### オプション2: 各イベントごとにZ値を個別計算
- 現在: 1サイクルのZ値を全イベントにコピー
- 提案: 各イベントフレームで個別にZ値計算

### オプション3: CSVに最良サイクル情報を追加
```csv
..., event_type, is_best_cycle, z_score_trunk, ...
..., left_strike, FALSE, , ...
..., left_strike, TRUE, -0.538, ...  ← 最良サイクルのみ
```

---

## ✅ 次のステップ

1. **APIレスポンスの確認**
   - `z_score_analysis.selected_cycle` の内容確認
   - どのフレームが最良サイクルとして選択されたか特定

2. **CSVスクリプトの修正**
   - 最良サイクルの情報を使用
   - 該当イベントのみにZ値を記載

3. **ドキュメント更新**
   - CSV見方ガイドに「最良サイクル」の説明追加
   - ユーザーに正しいZ値の読み方を伝える

---

## 📝 まとめ

**現状**:
- ✅ システムの動作自体は仕様通り（ワンサイクル解析）
- ❌ CSVへの書き込みロジックが不適切
- ❌ 最良サイクル以外のイベントにもZ値が入っている
- ❌ Z値の計算が手計算と合わない

**原因**:
- CSV生成スクリプトが、選択されたサイクル情報を考慮せずに、全イベントフレームにZ値を書き込んでいる

**推奨**:
- APIレスポンスから `selected_cycle` 情報を取得
- 最良サイクルのイベントのみにZ値を記載するよう修正

---

**検証者**: AI Assistant  
**レビュー必要**: Yes


