# 骨格推定システム改善案の精査結果

## 評価基準
- **効果**: 問題解決への寄与度（高/中/低）
- **実装難易度**: 実装の複雑さ（低/中/高）
- **リスク**: 既存システムへの影響（低/中/高）
- **優先度**: 実装すべき優先順位（最優先/高/中/低/保留）

---

## 1. 左右の区別（ID Switch）対策

### 1-A. ユークリッド距離による同一性チェック

**評価**:
- **効果**: ⭐⭐⭐⭐⭐ (非常に高い)
- **実装難易度**: ⭐⭐ (中程度)
- **リスク**: ⭐ (低)
- **優先度**: **最優先**

**理由**:
- ✅ **現在の問題に直接対応**: 「片足がずっと後ろ、片足がずっと前」という問題を根本的に解決
- ✅ **実装が比較的簡単**: 前フレームとの距離計算のみ
- ✅ **既存システムへの影響が小さい**: 追加ロジックのみで、既存コードを大きく変更しない
- ✅ **即効性が高い**: 実装すればすぐに効果が期待できる

**実装時の注意点**:
- 距離の閾値設定が重要（動きの速さに応じて調整が必要）
- 最初の数フレームは判定できないため、初期化処理が必要

**推奨**: **実装すべき（最優先）**

---

### 1-B. Z軸（深度）情報の活用

**評価**:
- **効果**: ⭐⭐⭐⭐ (高い)
- **実装難易度**: ⭐⭐⭐ (やや高い)
- **リスク**: ⭐⭐ (中程度)
- **優先度**: **高**

**理由**:
- ✅ **横から撮影の場合に非常に有効**: ランニングマシンや横からの撮影では、z値の差が明確
- ⚠️ **landmarks_worldの取得が必要**: 現在は`pose_landmarks`のみ使用、`pose_world_landmarks`への変更が必要
- ⚠️ **カメラ角度に依存**: 背後からの撮影では効果が薄い可能性
- ✅ **1-Aと組み合わせると強力**: 両方を実装すれば、より確実

**実装時の注意点**:
- MediaPipeの`results.pose_world_landmarks`を使用する必要がある
- カメラ角度（side/back）に応じて使い分けが必要
- z値のスケールが正規化座標と異なるため、処理ロジックの調整が必要

**推奨**: **実装すべき（1-Aの後に実装）**

---

## 2. スムージングの高度化：One Euro Filter

**評価**:
- **効果**: ⭐⭐⭐⭐ (高い)
- **実装難易度**: ⭐⭐ (中程度)
- **リスク**: ⭐ (低)
- **優先度**: **高**

**理由**:
- ✅ **現在の問題を解決**: 「動きが不自然」「遅延」の問題を改善
- ✅ **ランニング動作に最適**: 接地時の急激な動きと滞空時の緩やかな動きの両方に対応
- ✅ **実装が比較的簡単**: 既存のアルゴリズムがあり、パラメータ調整のみ
- ⚠️ **パラメータ調整が必要**: 動きの速さに応じて最適化が必要

**現在のシステムとの比較**:
- 現在: 加重移動平均（固定の重み）
- One Euro Filter: 動きの速さに応じて重みを動的に変更

**実装時の注意点**:
- 速度（velocity）の計算が必要
- パラメータ（min_cutoff, beta）の調整が必要
- 各キーポイントごとに独立して適用するか、全体で適用するか検討が必要

**推奨**: **実装すべき（1-Aの後に実装）**

---

## 3. 構造的制約の強化：ボーン長一定の原則

**評価**:
- **効果**: ⭐⭐⭐ (中程度)
- **実装難易度**: ⭐⭐⭐⭐ (高い)
- **リスク**: ⭐⭐⭐ (高い)
- **優先度**: **中**

**理由**:
- ✅ **物理的制約を活用**: 理論的には正しいアプローチ
- ⚠️ **実装が複雑**: ボーン長の基準値計算、異常検出、補正ロジックが必要
- ⚠️ **誤検出のリスク**: 正常な動きを異常と判定する可能性
- ⚠️ **Inverse Kinematicsは過剰**: 単純な補正で十分な可能性

**懸念点**:
- ランニング中でも、角度によってはボーン長が「見かけ上」変わる（遠近法）
- 初期フレームで基準値を取得するが、そのフレームが誤検出の可能性もある
- 補正ロジックが複雑になると、デバッグが困難

**代替案**:
- ボーン長のチェックは「異常検出」のみに使用し、補正は前フレームの値を使用する程度に留める
- Inverse Kinematicsは実装せず、シンプルな補正のみ

**推奨**: **条件付きで実装（簡易版のみ）**
- ボーン長の異常検出は実装
- 補正は前フレームの値を使用する程度に留める
- Inverse Kinematicsは実装しない（過剰）

---

## 4. モデルの再考とアンサンブル

**評価**:
- **効果**: ⭐⭐⭐⭐⭐ (非常に高い - 長期的)
- **実装難易度**: ⭐⭐⭐⭐⭐ (非常に高い)
- **リスク**: ⭐⭐⭐⭐ (非常に高い)
- **優先度**: **保留（長期的検討）**

**理由**:
- ✅ **根本的な精度向上**: MediaPipeの限界を超える可能性
- ❌ **実装コストが非常に高い**: 新しいモデルの導入、学習、統合が必要
- ❌ **既存システムへの影響が大きい**: データ形式の変更、APIの変更が必要
- ❌ **リソース消費の増加**: GPUが必要になる可能性、処理時間の増加

**4-A. YOLOv8-Pose / RTMPose の検討**:
- **効果**: ⭐⭐⭐⭐ (高い)
- **実装難易度**: ⭐⭐⭐⭐ (高い)
- **推奨**: **保留（MediaPipeで限界を感じた場合に検討）**

**4-B. 2段階推論**:
- **効果**: ⭐⭐⭐ (中程度)
- **実装難易度**: ⭐⭐⭐ (やや高い)
- **推奨**: **条件付きで実装（YOLOで人物検出は既に実装されている可能性があるため、確認後検討）**

**推奨**: **現時点では保留**
- まずは1-A, 1-B, 2を実装して効果を確認
- MediaPipeで限界を感じた場合に検討
- 実装する場合は、段階的に（まずは2段階推論から）

---

## 5. ランニング特化のドメイン知識適用（周期性の利用）

**評価**:
- **効果**: ⭐⭐⭐⭐ (高い)
- **実装難易度**: ⭐⭐⭐⭐ (高い)
- **リスク**: ⭐⭐ (中程度)
- **優先度**: **中（1-A, 1-B, 2の後に検討）**

**理由**:
- ✅ **ランニングに特化した改善**: ドメイン知識を活用した高度な手法
- ✅ **検出が飛んだ場合の補完に有効**: 周期的な動きを利用した自然な補完
- ⚠️ **実装が複雑**: 位相解析、周期検出、予測補完のロジックが必要
- ⚠️ **ランニング以外には適用不可**: 汎用性が低い

**実装時の注意点**:
- ランニングサイクルの検出が必要（ストライド検出など）
- 位相の判定（Stance/Swing）が正確でないと逆効果
- 周期が一定でない場合（加速・減速）の対応が必要

**推奨**: **条件付きで実装（簡易版から）**
- まずは1-A, 1-B, 2を実装して効果を確認
- それでも問題が残る場合、簡易版の周期補完を実装
- 完全な位相解析は後回し

---

## 総合推奨順序

### フェーズ1（最優先・即座に実装）
1. **1-A. ユークリッド距離による同一性チェック** ⭐⭐⭐⭐⭐
   - 効果が高く、実装が比較的簡単
   - 現在の問題に直接対応

### フェーズ2（高優先度・フェーズ1の後に実装）
2. **1-B. Z軸（深度）情報の活用** ⭐⭐⭐⭐
   - 1-Aと組み合わせると強力
   - 横からの撮影に特に有効

3. **2. One Euro Filter** ⭐⭐⭐⭐
   - 動きの自然さを大幅に改善
   - 実装難易度が中程度

### フェーズ3（中優先度・効果確認後に検討）
4. **3. ボーン長一定の原則（簡易版）** ⭐⭐⭐
   - 異常検出のみ実装
   - 補正は前フレームの値を使用

5. **5. 周期性の利用（簡易版）** ⭐⭐⭐
   - 検出が飛んだ場合の補完に使用
   - 完全な位相解析は後回し

### フェーズ4（保留・長期的検討）
6. **4. モデルの再考とアンサンブル** ⭐⭐
   - MediaPipeで限界を感じた場合に検討
   - 実装コストが非常に高い

---

## 実装時の推奨アプローチ

### ステップ1: 1-Aの実装と効果確認
- ユークリッド距離によるID Switch対策を実装
- テスト動画で効果を確認
- 問題が解決すれば、他の改善は後回しでも可

### ステップ2: 1-Bと2の実装
- 1-Aで問題が残る場合、1-Bを追加
- 動きの自然さに問題がある場合、2を追加
- それぞれ個別に効果を確認

### ステップ3: 必要に応じて3と5を検討
- まだ問題が残る場合のみ実装
- 簡易版から始める

### ステップ4: 4は最後の手段
- 上記すべてを試しても限界を感じる場合のみ検討

---

## 各改善案の実装時間見積もり

- **1-A. ユークリッド距離**: 2-4時間
- **1-B. Z軸活用**: 4-6時間
- **2. One Euro Filter**: 3-5時間
- **3. ボーン長（簡易版）**: 6-8時間
- **5. 周期性（簡易版）**: 8-12時間
- **4. モデル変更**: 40-80時間（大幅な変更のため）

---

## 結論

**最優先で実装すべき**: 1-A（ユークリッド距離による同一性チェック）
- 現在の問題に直接対応
- 実装が比較的簡単
- 即効性が高い

**次に実装すべき**: 1-B（Z軸活用）と2（One Euro Filter）
- 1-Aと組み合わせると強力
- 動きの自然さも改善

**保留すべき**: 4（モデル変更）
- 実装コストが非常に高い
- まずは既存モデルでの改善を試すべき

