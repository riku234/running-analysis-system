# Z値分析で確実にサイクルを検出できる動画の条件

## 📋 概要

このドキュメントは、Z値分析（Z-score analysis）で「いいサイクルが検出できませんでした」というエラーを回避し、確実にランニングサイクルを検出するための動画条件をまとめたものです。

---

## 🎯 サイクル検出の仕組み

### 1. 検出プロセス

システムは以下の手順でランニングサイクルを検出します：

```
動画アップロード
    ↓
骨格推定（MediaPipe Pose）
    ↓
足首のY座標を追跡
    ↓
接地・離地イベントを検出
    ↓
ワンサイクルを特定
    ↓
Z値分析
```

### 2. 検出ロジックの詳細

**足接地・離地の検出方法**:
- **足首のY座標**（左: ランドマーク27、右: ランドマーク28）を追跡
- **接地（strike）**: 足首Y座標の極小値（足首が最も下）
- **離地（off）**: 足首Y座標の極大値（足首が最も上）
- **scipy.signal.find_peaks**を使用して極値を検出

**検出パラメータ**:
```python
min_distance = max(3, int(video_fps * 0.15))  # 最小間隔0.15秒
height_threshold = np.percentile(y_coords, 50)  # 上位50%の極値
prominence = 0.002  # 突出度（より寛容）
```

### 3. サイクル特定の条件

最低限必要なイベント数:
- ✅ **右足接地（right_strike）**: 1回以上
- ✅ **右足離地（right_off）**: 1回以上
- ✅ **左足接地（left_strike）**: 1回以上
- ✅ **左足離地（left_off）**: 1回以上

**合計: 最低4イベント必要**

---

## ✅ 確実にサイクルを検出できる動画の条件

### 1. 撮影時間・フレーム数

| 項目 | 推奨値 | 最低限 | 理由 |
|------|--------|--------|------|
| **動画の長さ** | 5秒以上 | 3秒以上 | 複数のランニングサイクルを含む |
| **フレームレート** | 30fps | 24fps | 足の動きを正確に追跡 |
| **総フレーム数** | 150フレーム以上 | 72フレーム以上 | 十分なデータポイント |

**計算例**:
- 3秒 × 30fps = 90フレーム（最低限）
- 5秒 × 30fps = 150フレーム（推奨）

### 2. 撮影角度・構図

#### ✅ 推奨される撮影角度

```
【真横から撮影（90度）】
    
    カメラ ←―――――→ ランナー
    📹              🏃
    
    ✅ 足の動きが明確
    ✅ 足首の上下動が正確に測定可能
```

#### ❌ 避けるべき撮影角度

```
【斜め前/斜め後ろから撮影】
    
    カメラ
    📹
     ＼
      ＼
       🏃 ランナー
    
    ❌ 足の動きが不明瞭
    ❌ Y座標の変化が小さくなる
```

**推奨撮影角度**: 真横（±15度以内）

### 3. ランナーの位置・サイズ

| 項目 | 推奨値 | 理由 |
|------|--------|------|
| **画面内の位置** | 中央 | 骨格検出の精度向上 |
| **体全体の表示** | 頭から足先まで | 全ランドマークの検出 |
| **画面占有率** | 40-60% | 適切な解像度 |
| **カメラからの距離** | 3-5m | 適切なサイズと精度 |

```
【良い例】
┌─────────────────────┐
│                     │
│                     │
│       🏃           │  ← 体全体が画面中央
│                     │
│                     │
└─────────────────────┘

【悪い例】
┌─────────────────────┐
│  🏃                │  ← 画面端に寄りすぎ
│                     │
│                     │
└─────────────────────┘
```

### 4. ランニング動作

| 項目 | 推奨値 | 理由 |
|------|--------|------|
| **走行速度** | 一定 | 安定したサイクル検出 |
| **ランニングサイクル数** | 2-3サイクル以上 | 最良サイクルの選択 |
| **足の動き** | 明確な接地・離地 | イベント検出の精度 |
| **走行方向** | 左→右 または 右→左 | 一方向が望ましい |

**ランニングサイクルの定義**:
```
1サイクル = 右足接地 → 右足離地 → 左足接地 → 左足離地 → (次の右足接地)
```

### 5. 撮影環境

| 項目 | 推奨値 | 理由 |
|------|--------|------|
| **照明** | 明るい | 骨格検出の精度向上 |
| **背景** | シンプル | ランナーの識別容易 |
| **カメラの安定性** | 固定（三脚推奨） | ブレによる誤検出防止 |
| **障害物** | なし | ランナーの全身が常に見える |

### 6. 動画品質

| 項目 | 推奨値 | 最低限 | 理由 |
|------|--------|--------|------|
| **解像度** | 1920x1080 (Full HD) | 1280x720 (HD) | 骨格検出の精度 |
| **ビットレート** | 5-10 Mbps | 2 Mbps | 画質の維持 |
| **圧縮** | 低圧縮 | 中圧縮 | ディテールの保持 |

---

## 🎬 動画フォーマット（MP4 vs MOV）

### 結論: **フォーマットによる検出精度の違いはありません**

システムは以下のフォーマットをサポートしています：
- ✅ MP4 (H.264/H.265)
- ✅ MOV (QuickTime)
- ✅ AVI
- ✅ MKV
- ✅ WMV

### 技術的な理由

1. **OpenCVによる統一処理**
   ```python
   cap = cv2.VideoCapture(video_path)  # すべてのフォーマットを同じ方法で読み込み
   ```

2. **フレーム抽出の仕組み**
   - OpenCVがコンテナフォーマット（MP4/MOV）を自動認識
   - 内部のコーデック（H.264等）を自動デコード
   - RGBフレームとして統一的に処理

3. **MediaPipeへの入力**
   - すべてのフォーマットが同じRGB配列に変換される
   - フォーマットの違いは完全に吸収される

### MP4とMOVの違い

| 項目 | MP4 | MOV | 影響 |
|------|-----|-----|------|
| **コンテナ** | MPEG-4 | QuickTime | なし（OpenCVが吸収） |
| **デフォルトコーデック** | H.264 | H.264 | なし（同じ） |
| **互換性** | 高い | Apple製品で高い | なし（両方サポート） |
| **ファイルサイズ** | 小さめ | 大きめ | なし（品質が同じなら） |

### 「MOVだとうまくいく」と感じる理由

以下の可能性が考えられます：

1. **ビットレートの違い**
   - MOVファイルが高ビットレート → 高画質 → 骨格検出精度向上
   - MP4ファイルが低ビットレート → 低画質 → 骨格検出精度低下

2. **撮影デバイスの違い**
   - iPhoneで撮影（MOV） → 高品質、適切な設定
   - 他のデバイスで撮影（MP4） → 品質が低い可能性

3. **圧縮設定の違い**
   - MOV: 低圧縮 → ディテール保持
   - MP4: 高圧縮 → ディテール損失

**重要**: フォーマット自体ではなく、**動画の品質**が検出精度に影響します。

---

## ❌ サイクル検出が失敗する典型的なパターン

### 1. 動画が短すぎる

```
動画の長さ: 1-2秒
    ↓
ランニングサイクル: 0.5-1サイクル
    ↓
検出イベント: 2-3個（不足）
    ↓
❌ エラー: 「いいサイクルが検出できませんでした」
```

**対策**: 最低3秒、推奨5秒以上の動画を撮影

### 2. 撮影角度が不適切

```
斜め前から撮影
    ↓
足の上下動が小さく見える
    ↓
Y座標の変化が小さい
    ↓
極値検出が困難
    ↓
❌ イベント検出失敗
```

**対策**: 真横から撮影（±15度以内）

### 3. ランナーが画面外に出る

```
ランナーが画面端で切れる
    ↓
足首のランドマーク検出失敗
    ↓
Y座標データが欠損
    ↓
❌ イベント検出失敗
```

**対策**: 体全体が常に画面内に収まるように撮影

### 4. 走行速度が不安定

```
加速・減速が激しい
    ↓
サイクルの品質が低い
    ↓
品質スコアが低い
    ↓
❌ 最良サイクルの選択失敗
```

**対策**: 一定速度で走行

### 5. 照明が暗い

```
暗い環境で撮影
    ↓
骨格検出の信頼度が低い
    ↓
ランドマークの位置が不正確
    ↓
❌ イベント検出の精度低下
```

**対策**: 明るい環境で撮影

### 6. カメラが手ブレしている

```
手持ち撮影でブレる
    ↓
Y座標にノイズが混入
    ↓
誤った極値を検出
    ↓
❌ 誤ったイベント検出
```

**対策**: 三脚を使用して固定撮影

---

## 📊 検出成功率を高めるチェックリスト

### 撮影前

- [ ] カメラを三脚で固定
- [ ] ランナーの走行ラインを真横から撮影できる位置に設置
- [ ] カメラからの距離: 3-5m
- [ ] 照明が十分に明るいことを確認
- [ ] 背景がシンプルであることを確認

### 撮影中

- [ ] ランナーの体全体が画面内に収まっている
- [ ] ランナーが画面中央を通過する
- [ ] 一定速度で走行している
- [ ] 最低3秒、できれば5秒以上撮影
- [ ] 2-3回のランニングサイクルが含まれている

### 撮影後

- [ ] 動画の長さ: 3秒以上
- [ ] フレームレート: 24fps以上
- [ ] 解像度: 720p以上
- [ ] ファイルサイズ: 500MB以下
- [ ] フォーマット: MP4, MOV, AVI, MKV, WMVのいずれか

---

## 🔧 トラブルシューティング

### エラー: 「いいサイクルが検出できませんでした」

#### 原因1: イベント数が不足

**確認方法**:
- ブラウザのコンソールログで「検出イベント数」を確認
- 4イベント未満の場合は不足

**対策**:
- 動画を長くする（5秒以上）
- より明確な走行動作を撮影

#### 原因2: 撮影角度が不適切

**確認方法**:
- 動画を見て、足の上下動が明確か確認
- 真横から撮影されているか確認

**対策**:
- 真横（±15度以内）から再撮影

#### 原因3: 骨格検出の失敗

**確認方法**:
- 結果ページで骨格線が正しく表示されているか確認
- 足首のランドマークが常に検出されているか確認

**対策**:
- 明るい環境で再撮影
- ランナーを画面中央に配置
- 解像度を上げる（Full HD推奨）

#### 原因4: ランナーが画面外に出ている

**確認方法**:
- 動画を見て、体全体が常に画面内にあるか確認

**対策**:
- カメラの画角を広げる
- カメラの位置を調整
- ズームアウト

---

## 📝 推奨撮影設定（デバイス別）

### iPhone

```
設定 > カメラ
- フォーマット: 互換性優先（H.264）
- ビデオ撮影: 1080p HD/30fps または 60fps
- 手ぶれ補正: オン
```

### Android

```
カメラアプリ
- 解像度: Full HD (1920x1080)
- フレームレート: 30fps
- 手ぶれ補正: オン
```

### デジタルカメラ

```
- 動画モード: MP4 (H.264)
- 解像度: 1920x1080
- フレームレート: 30fps
- ISO: オート
- シャッタースピード: 1/250以上（動きのブレ防止）
```

---

## 🎯 理想的な撮影例

### セットアップ

```
【トップビュー】

背景（壁/フェンス）
    ║
    ║
    ║  ← ランナーの走行ライン（3-5m）
    ║
    ║
    ║
  📹 カメラ（三脚で固定、高さ1-1.5m）
```

### タイムライン

```
0秒    1秒    2秒    3秒    4秒    5秒
├──────┼──────┼──────┼──────┼──────┤
        🏃→   →🏃   →🏃   →🏃
        
サイクル1      サイクル2      サイクル3
```

### 結果

```
✅ 検出イベント数: 12個
   - 右足接地: 3回
   - 右足離地: 3回
   - 左足接地: 3回
   - 左足離地: 3回

✅ サイクル候補数: 3個

✅ 最良サイクル選択: サイクル2（スコア: 0.95）

✅ Z値分析: 成功
```

---

## 📚 参考情報

### システムの技術仕様

- **骨格推定**: MediaPipe Pose（33ランドマーク）
- **動画読み込み**: OpenCV (`cv2.VideoCapture`)
- **信号処理**: scipy (`scipy.signal.find_peaks`)
- **極値検出**: ガウシアンフィルタ + ピーク検出

### サポートされるファイル形式

| 形式 | 拡張子 | コーデック例 | 推奨度 |
|------|--------|------------|--------|
| MP4 | .mp4 | H.264, H.265 | ⭐⭐⭐ |
| MOV | .mov | H.264, ProRes | ⭐⭐⭐ |
| AVI | .avi | MJPEG, DivX | ⭐⭐ |
| MKV | .mkv | H.264, VP9 | ⭐⭐ |
| WMV | .wmv | WMV9 | ⭐ |

### ファイルサイズ制限

- **最大サイズ**: 500MB
- **推奨サイズ**: 10-50MB（5秒、Full HD、H.264の場合）

---

## ✅ まとめ

### 最も重要な3つのポイント

1. **動画の長さ**: 最低3秒、推奨5秒以上
2. **撮影角度**: 真横から（±15度以内）
3. **画面内の位置**: 体全体が常に画面中央に

### フォーマットについて

- ✅ **MP4とMOVに検出精度の違いはありません**
- ✅ 重要なのは**動画の品質**（解像度、ビットレート、照明）
- ✅ どちらのフォーマットでも、上記の条件を満たせば確実に検出できます

### 困ったときは

1. このドキュメントのチェックリストを確認
2. 動画を5秒以上、真横から、明るい環境で再撮影
3. それでも失敗する場合は、結果ページのコンソールログを確認

---

**作成日**: 2025年10月19日  
**対象システム**: Running Analysis System v1.0  
**関連サービス**: pose_estimation, analysis

