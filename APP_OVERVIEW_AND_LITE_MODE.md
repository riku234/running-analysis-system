# ランニング動画自動解析システム - アプリ概要とLiteモード詳細解説

**最終更新日**: 2025年12月23日  
**バージョン**: 3.0.0

---

## 📋 目次

1. [アプリ概要](#1-アプリ概要)
2. [システムアーキテクチャ](#2-システムアーキテクチャ)
3. [解析モードの種類](#3-解析モードの種類)
4. [Liteモード詳細解説](#4-liteモード詳細解説)
5. [Proモードとの違い](#5-proモードとの違い)
6. [背後解析モード](#6-背後解析モード)
7. [技術スタック](#7-技術スタック)
8. [データフロー](#8-データフロー)
9. [開発・デプロイ情報](#9-開発デプロイ情報)

---

## 1. アプリ概要

### 1.1 プロジェクト概要

**ランニング動画自動解析システム**は、ランニング動画をアップロードするだけで、AIが自動的にフォームを解析し、詳細な評価と改善アドバイスを提供するWebアプリケーションです。

### 1.2 主な機能

- **動画アップロード**: ドラッグ&ドロップで簡単に動画をアップロード
- **骨格検出**: MediaPipe Poseによる33個のランドマーク検出
- **Z値統計分析**: 標準モデルとの偏差を統計的に評価
- **AIアドバイス生成**: Google Gemini AIによるパーソナライズされたアドバイス
- **3つの解析モード**: Lite Mode（ビギナー向け）、Pro Mode（エキスパート向け）、背後解析モード

### 1.3 ターゲットユーザー

- アマチュアランナー
- 陸上競技選手
- ランニングコーチ
- スポーツトレーナー

---

## 2. システムアーキテクチャ

### 2.1 マイクロサービス構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Next.js Frontend (Port: 3000)             │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway (Nginx, Port: 80)            │
└──────────────────────────┬──────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│Video          │  │Pose          │  │Feature       │
│Processing     │  │Estimation    │  │Extraction    │
│Port: 8001     │  │Port: 8002     │  │Port: 8003     │
└───────────────┘  └───────────────┘  └───────────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│Analysis       │  │Advice         │  │Back View      │
│(Z-Score)      │  │Generation     │  │Analysis      │
│Port: 8004     │  │Port: 8005       │  │Port: 8006     │
└───────────────┘  └───────────────┘  └───────────────┘
```

### 2.2 サービス一覧

| サービス名 | ポート | 役割 |
|-----------|-------|------|
| **Frontend** | 3000 | UIとユーザー操作 |
| **API Gateway** | 80 | リクエストルーティング |
| **Video Processing** | 8001 | 動画アップロード・前処理 |
| **Pose Estimation** | 8002 | 骨格キーポイント検出 |
| **Feature Extraction** | 8003 | 特徴量計算 |
| **Analysis** | 8004 | Z値統計分析 |
| **Advice Generation** | 8005 | AIアドバイス生成 |
| **Back View Analysis** | 8006 | 背後解析（Hip Drop、上下動、クロスオーバー） |

---

## 3. 解析モードの種類

アプリには3つの解析モードがあります：

### 3.1 Lite Mode（ビギナー向け）

**特徴**:
- 直感的なUI
- 3要素のレーダーチャート表示
- シンプルなステータス表示
- 最優先課題（One Big Thing）の表示

**対象ユーザー**: ランニング初心者、フォーム改善を始めたい人

### 3.2 Pro Mode（エキスパート向け）

**特徴**:
- 詳細なグラフ表示
- 動画プレーヤーに骨格スケルトンオーバーレイ
- 角度時系列グラフ
- 詳細なZ値分析結果

**対象ユーザー**: コーチ、トレーナー、詳細な分析が必要な人

### 3.3 背後解析モード

**特徴**:
- 背後からの撮影動画専用
- Hip Drop（骨盤の傾き）解析
- Vertical Oscillation（上下動）解析
- Crossover（クロスオーバー）解析

**対象ユーザー**: ランニングマシンでの撮影、背後からの分析が必要な人

---

## 4. Liteモード詳細解説

### 4.1 Liteモードの目的

Liteモードは、**ランニング初心者やフォーム改善を始めたい人**を対象に、複雑なデータを分かりやすく可視化し、**最も重要な改善点を1つだけ**提示することで、ユーザーが迷わずに行動できるように設計されています。

### 4.2 Liteモードの画面構成

Liteモードの結果画面は、以下の3つの主要セクションで構成されています：

```
┌─────────────────────────────────────────────────────────┐
│  1. 3つの力（レーダーチャート）                          │
│     - POSTURE（姿勢）                                    │
│     - LANDING（着地）                                    │
│     - SWING（スイング）                                  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  2. ステータスリスト                                     │
│     - 各要素の状態（良好/注意/要改善）                   │
│     - Z値の表示                                          │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  3. One Big Thing（最優先課題）                          │
│     - 最も重要な改善点を1つだけ表示                      │
│     - 現象・原因・改善策・ドリルを表示                   │
└─────────────────────────────────────────────────────────┘
```

### 4.3 「3つの力」レーダーチャート

#### 4.3.1 概要

「3つの力」は、ランニングフォームを3つの要素に分解して評価する指標です：

1. **POSTURE（姿勢）**: 体幹角度の評価
2. **LANDING（着地）**: 下腿角度の評価
3. **SWING（スイング）**: 大腿角度の評価

#### 4.3.2 計算方法

各要素のスコアは、Z値分析の結果から計算されます：

```typescript
// Z値からスコアへの変換式
const zToScore = (z: number): number => {
  if (z === 0) return 100      // Z値が0なら100点
  if (z >= 10) return 0        // Z値が10以上なら0点
  return Math.max(0, Math.round(100 - (z / 10) * 100))
}
```

**Z値の取得方法**:
- 全イベント（right_strike, right_off, left_strike, left_off）から最大のZ値を取得
- 複数の角度名を試してマッチング（例: `体幹角度`, `trunk_angle`, `trunk_angle_z`）

**各要素の対応角度**:
- **POSTURE**: `体幹角度`, `trunk_angle`
- **LANDING**: `右下腿角度`, `左下腿角度`, `shank_angle`, `right_shank_angle`, `left_shank_angle`
- **SWING**: `右大腿角度`, `左大腿角度`, `thigh_angle`, `right_thigh_angle`, `left_thigh_angle`

#### 4.3.3 表示方法

- **レーダーチャート**: 3要素を極座標系で表示
- **スコア範囲**: 0-100点
- **色**: 青（#3b82f6）で表示

### 4.4 ステータスリスト

#### 4.4.1 概要

各要素（POSTURE、LANDING、SWING）の状態を視覚的に表示します。

#### 4.4.2 評価基準

| Z値範囲 | 評価 | アイコン | 色 |
|--------|------|---------|-----|
| \|Z\| < 1.0 | 良好 | ✅ CheckCircle | 緑 |
| 1.0 ≤ \|Z\| < 2.0 | 注意 | ⚠️ AlertTriangle | 黄 |
| \|Z\| ≥ 2.0 | 要改善 | ❌ AlertCircle | 赤 |

#### 4.4.3 表示内容

各要素について以下を表示：
- **カテゴリ名**: POSTURE / LANDING / SWING
- **ステータス**: 良好 / 注意 / 要改善
- **Z値**: 最大Z値（小数点以下2桁）

### 4.5 One Big Thing（最優先課題）

#### 4.5.1 概要

「One Big Thing」は、**最も重要な改善点を1つだけ**表示する機能です。複数の課題がある場合でも、ユーザーが迷わずに行動できるように、優先度が最も高い課題を1つだけ提示します。

#### 4.5.2 選択ロジック

最優先課題は、以下のロジックで選択されます：

1. **Z値分析結果から課題リストを取得** (`raw_issues`)
2. **各課題について対応するZ値を取得**
   - `target_metric`または`angle`から角度名を特定
   - Z値データから該当する角度のZ値を取得
3. **優先度の計算**
   - 基本優先度 = 最大Z値
   - `severity === 'high'`の場合は +2.0 を加算
4. **最も優先度が高い課題を選択**

#### 4.5.3 表示内容

選択された課題について、以下の情報を表示：

1. **課題名** (`name`): 例: "体幹前傾", "左下腿角度大"
2. **現象** (`observation`): 何が起きているか
3. **原因** (`cause`): なぜ起きているか
4. **改善策** (`action`): どう改善するか
5. **ドリル** (`drill.name`): 具体的な練習方法

#### 4.5.4 データ取得の優先順位

1. **第一優先**: `raw_issues`から直接取得
   - `observation`, `cause`, `action`, `drill`
2. **第二優先**: `ai_advice.message`から抽出
   - 課題名に一致する部分を正規表現で抽出

### 4.6 Liteモードのデータフロー

```
┌─────────────────────────────────────────────────────────┐
│  1. 動画アップロード                                      │
│     - ユーザーが動画を選択                                │
│     - analysisMode='lite'で送信                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  2. バックエンド解析パイプライン                          │
│     - 骨格検出 (Pose Estimation)                         │
│     - 特徴量計算 (Feature Extraction)                          │
│     - Z値分析 (Analysis)                                 │
│     - アドバイス生成 (Advice Generation)                │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  3. フロントエンド結果表示                                │
│     - /result/{id}?mode=lite にリダイレクト              │
│     - AnalysisResultLiteコンポーネントを表示             │
│     - Z値データとアドバイスデータを受け取る              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  4. データ処理                                           │
│     - Z値から3要素のスコアを計算                         │
│     - ステータスリストを生成                             │
│     - One Big Thingを選択                                │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  5. UI表示                                               │
│     - レーダーチャート表示                               │
│     - ステータスリスト表示                               │
│     - One Big Thing表示                                  │
└─────────────────────────────────────────────────────────┘
```

### 4.7 Liteモードの技術実装

#### 4.7.1 コンポーネント構成

**ファイル**: `frontend/app/components/AnalysisResultLite.tsx`

**主要な処理**:

1. **Z値からスコアへの変換** (`radarData`)
   ```typescript
   const radarData = useMemo(() => {
     // Z値データから3要素の最大Z値を取得
     const postureZ = getMaxZScore(['体幹角度', 'trunk_angle'])
     const landingZ = getMaxZScore(['右下腿角度', '左下腿角度', 'shank_angle'])
     const swingZ = getMaxZScore(['右大腿角度', '左大腿角度', 'thigh_angle'])
     
     // Z値を100点満点スコアに変換
     return [
       { category: 'POSTURE', score: zToScore(postureZ) },
       { category: 'LANDING', score: zToScore(landingZ) },
       { category: 'SWING', score: zToScore(swingZ) }
     ]
   }, [zScoreData])
   ```

2. **ステータスリストの生成** (`statusList`)
   ```typescript
   const statusList = useMemo(() => {
     // 各要素の最大Z値を取得
     // Z値に基づいてステータス（良好/注意/要改善）を決定
     return [
       getStatus('POSTURE', ['体幹角度', 'trunk_angle']),
       getStatus('LANDING', ['右下腿角度', '左下腿角度', 'shank_angle']),
       getStatus('SWING', ['右大腿角度', '左大腿角度', 'thigh_angle'])
     ]
   }, [zScoreData])
   ```

3. **One Big Thingの選択** (`oneBigThing`)
   ```typescript
   const oneBigThing = useMemo(() => {
     // raw_issuesから各課題のZ値を取得
     // 優先度が最も高い課題を選択
     // 現象・原因・改善策・ドリルを組み立て
   }, [adviceData, zScoreData])
   ```

#### 4.7.2 使用ライブラリ

- **Recharts**: レーダーチャートの描画
- **React Hooks**: `useMemo`でパフォーマンス最適化
- **Tailwind CSS**: スタイリング

### 4.8 LiteモードのUX設計思想

#### 4.8.1 シンプルさの追求

- **3要素に集約**: 複雑な角度データを3つの要素に集約
- **1つの課題に集中**: 複数の課題がある場合でも、最も重要な1つだけを表示
- **視覚的な理解**: レーダーチャートとステータスアイコンで直感的に理解

#### 4.8.2 行動を促す設計

- **明確な改善策**: 現象・原因・改善策・ドリルを明確に表示
- **優先順位の明確化**: One Big Thingで「何をすべきか」を明確に
- **モチベーション維持**: スコア表示で改善の進捗を可視化

---

## 5. Proモードとの違い

### 5.1 表示内容の違い

| 項目 | Lite Mode | Pro Mode |
|------|-----------|----------|
| **レーダーチャート** | ✅ 3要素のみ | ❌ なし |
| **ステータスリスト** | ✅ シンプル | ❌ なし |
| **One Big Thing** | ✅ 1つの課題 | ❌ なし |
| **動画プレーヤー** | ❌ なし | ✅ 骨格スケルトンオーバーレイ |
| **角度時系列グラフ** | ❌ なし | ✅ 詳細なグラフ表示 |
| **詳細なZ値分析** | ❌ なし | ✅ イベント別の詳細表示 |
| **統合アドバイス** | ❌ なし | ✅ Markdown形式の詳細アドバイス |

### 5.2 対象ユーザーの違い

| モード | 対象ユーザー | 用途 |
|--------|------------|------|
| **Lite Mode** | ランニング初心者 | フォーム改善の第一歩 |
| **Pro Mode** | コーチ・トレーナー | 詳細な分析と指導 |

### 5.3 データの詳細度

- **Lite Mode**: 集約されたデータ（3要素、1つの課題）
- **Pro Mode**: 詳細なデータ（全イベント、全角度、全課題）

---

## 6. 背後解析モード

### 6.1 概要

背後解析モードは、**背後からの撮影動画**を解析する専用モードです。ランニングマシンでの撮影など、ランナーが固定位置にいる場合に使用します。

### 6.2 解析指標

1. **Hip Drop（骨盤の傾き）**
   - 左右の腰の高さの差を測定
   - 単位: 度（°）
   - 評価: 最大角度で判定

2. **Vertical Oscillation（上下動）**
   - 重心（腰の中点）の上下動の範囲
   - 単位: 身長比（%）
   - 評価: 身長に対する割合で判定

3. **Crossover（クロスオーバー）**
   - 着地時の足が体の中心線を超える角度
   - 単位: 度（°）
   - 評価: 最大角度で判定

### 6.3 計算方法

詳細は `backend/services/back_view_analysis/app/main.py` を参照してください。

---

## 7. 技術スタック

### 7.1 フロントエンド

- **Next.js 14** (App Router)
- **TypeScript**
- **Tailwind CSS**
- **Zustand** (状態管理)
- **Recharts** (グラフ描画)

### 7.2 バックエンド

- **Python 3.11+**
- **FastAPI**
- **MediaPipe Pose** (骨格検出)
- **NumPy, SciPy** (数値計算)
- **Google Gemini AI** (アドバイス生成)

### 7.3 インフラ

- **Docker & Docker Compose**
- **Nginx** (API Gateway)
- **PostgreSQL** (AWS RDS)
- **AWS EC2** (ホスティング)

---

## 8. データフロー

### 8.1 解析パイプライン

```
1. 動画アップロード
   ↓
2. 骨格検出 (MediaPipe Pose)
   ↓
3. 特徴量計算 (角度計算)
   ↓
4. Z値分析 (標準モデルとの比較)
   ↓
5. アドバイス生成 (Gemini AI)
   ↓
6. 結果表示 (Lite/Pro/Back Mode)
```

### 8.2 処理時間（目安）

| ステップ | 処理時間（10秒動画） |
|---------|------------------|
| 骨格検出 | 15-30秒 |
| 特徴量計算 | 1-3秒 |
| Z値分析 | 2-5秒 |
| アドバイス生成 | 5-15秒 |
| **合計** | **30-60秒** |

---

## 9. 開発・デプロイ情報

### 9.1 リポジトリ

- **GitHub**: https://github.com/riku234/running-analysis-system
- **ブランチ**: `main`

### 9.2 デプロイ環境

- **本番環境**: AWS EC2 (54.206.3.155)
- **データベース**: AWS RDS PostgreSQL
- **アクセスURL**: http://54.206.3.155/

### 9.3 主要ファイル

#### フロントエンド

- `frontend/app/page.tsx`: 動画アップロードページ
- `frontend/app/result/[id]/page.tsx`: 結果表示ページ
- `frontend/app/components/AnalysisResultLite.tsx`: Liteモードコンポーネント
- `frontend/app/components/BackViewAnalysisResult.tsx`: 背後解析コンポーネント

#### バックエンド

- `backend/services/video_processing/app/main.py`: 動画処理オーケストレーション
- `backend/services/pose_estimation/app/main.py`: 骨格検出
- `backend/services/feature_extraction/app/main.py`: 特徴量計算
- `backend/services/analysis/app/main.py`: Z値分析
- `backend/services/advice_generation/app/main.py`: アドバイス生成
- `backend/services/back_view_analysis/app/main.py`: 背後解析

### 9.4 環境変数

```bash
# .env ファイル
GEMINI_API_KEY=your_api_key
ENABLE_DB_SAVE=true
DB_HOST=running-analysis-db-single...
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=your_password
```

---

## 10. まとめ

### 10.1 Liteモードの特徴

- **シンプル**: 3要素のレーダーチャートで直感的に理解
- **集中**: One Big Thingで最も重要な改善点に集中
- **行動促進**: 明確な改善策とドリルで行動を促す

### 10.2 今後の拡張予定

- Liteモードの機能強化
- より詳細な可視化
- モバイル対応の最適化

---

**Document Version**: 1.0.0  
**Last Updated**: 2025年12月23日  
**Author**: Running Analysis System Development Team


